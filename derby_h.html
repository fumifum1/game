<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬26å› åˆå¹´ä»¤å’Œãƒ€ãƒ¼ãƒ“ãƒ¼ - åŒæœŸç‰ˆ</title>
    <style>
        :root {
            --primary: #3e2723;
            --bg-paper: #f4e7d3;
            --accent: #8b0000;
            --track-light: #8d6e63;
            --track-dark: #5d4037;
            --success: #2e7d32;
        }

        body {
            font-family: "serif", "YuMincho", "Yu Mincho", "MS Mincho", serif;
            background-color: var(--bg-paper);
            color: var(--primary);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            border: 8px solid var(--primary);
            min-height: 100vh;
            box-sizing: border-box;
        }

        @media (min-width: 768px) {
            body {
                border-width: 12px;
            }
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }

        .btn {
            display: inline-block;
            cursor: pointer;
            font-weight: 900;
            text-decoration: none;
            transition: all 0.2s;
            border: 4px solid var(--primary);
            padding: 10px 20px;
            margin: 5px;
            background: white;
            user-select: none;
        }

        .btn-primary {
            background-color: var(--success);
            color: white;
            padding: 15px 40px;
            font-size: 1.5rem;
            box-shadow: 4px 4px 0px #1b5e20;
        }

        .btn-primary:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .setup-header {
            border-bottom: 2px solid var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
        }

        /* QRã‚³ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã®ä¸­å¤®å¯„ã›è¨­å®š */
        #qrcode-container {
            background: white;
            padding: 20px;
            display: inline-flex;
            /* å†…å®¹ã«åˆã‚ã›ã¦å¹…ã‚’èª¿æ•´ */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            /* å·¦å³ãƒãƒ¼ã‚¸ãƒ³autoã§ä¸­å¤®å¯„ã› */
            border: 2px solid var(--primary);
        }

        #qrcode {
            display: flex;
            justify-content: center;
            margin: 0 auto;
        }

        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .prediction-item {
            border: 2px solid var(--primary);
            padding: 10px;
            cursor: pointer;
            background: white;
            font-weight: bold;
        }

        .prediction-item.selected {
            background: var(--accent);
            color: white;
        }

        .race-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .race-header {
            background: var(--primary);
            color: var(--bg-paper);
            padding: 10px;
            text-align: center;
        }

        .race-info-sub {
            font-size: 0.9rem;
            margin-top: 5px;
            color: #ffccbc;
            font-weight: bold;
        }

        .track-area {
            flex: 1;
            background-color: var(--track-dark);
            overflow-y: auto;
            position: relative;
            padding: 20px 0;
        }

        .lane {
            position: relative;
            height: 40px;
            background: var(--track-light);
            border-bottom: 1px solid var(--track-dark);
            display: flex;
            align-items: center;
        }

        .lane-num {
            width: 30px;
            height: 100%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 12px;
            z-index: 10;
        }

        .horse-sprite {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 20;
        }

        .horse-emoji {
            font-size: 28px;
            transform: scaleX(-1);
        }

        .horse-label {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--primary);
            padding: 0 4px;
            font-size: 10px;
            font-weight: 900;
            white-space: nowrap;
        }

        .goal-line {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            border-left: 4px dashed white;
        }

        .payout-card {
            background: white;
            border: 4px solid var(--primary);
            padding: 30px;
            margin: 20px auto;
            max-width: 600px;
        }

        .animate-pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

    <div id="app"></div>

    <script>
        const PAYOUT_SCENARIOS = [
            { id: 0, name: "ä¸€æ”«åƒé‡‘ï¼ˆç·å–ã‚Šï¼‰", ratios: [1.0, 0, 0], desc: "å‹åˆ©ã—ãŸä¸€é ­ãŒã€ã™ã¹ã¦ã‚’ç‹¬å ã™ã‚‹ã€‚" },
            { id: 1, name: "å¾¡ä¸‰å®¶ãƒ»ç­‰åˆ†", ratios: [0.34, 0.33, 0.33], desc: "ä¸Šä½3åãŒå‡ç­‰ã«åˆ†ã‘åˆã†ã€‚" },
            { id: 2, name: "å®ŸåŠ›ä¸»ç¾©ãƒ»å‚¾æ–œé…åˆ†", ratios: [0.6, 0.25, 0.15], desc: "1ä½ã«éåŠæ•°ã€2ä½ãƒ»3ä½ã«ã‚‚å ±ã„ã‚‹ã€‚" },
            { id: 3, name: "å¤§ç›¤æŒ¯ã‚‹èˆã„", ratios: [0.45, 0.35, 0.2], desc: "1ä½ã‹ã‚‰3ä½ã¾ã§ã€æ™¯æ°—ã‚ˆãåˆ†ã‘åˆã†ã€‚" },
            { id: 4, name: "çœŸå‰£å‹è² ï¼ˆäºŒå¼·ï¼‰", ratios: [0.65, 0.35, 0], desc: "1ä½ã¨2ä½ã®ã¿ãŒæœå®Ÿã‚’æ‰‹ã«ã™ã‚‹ã€‚" },
        ];

        class SeededRandom {
            constructor(seed) { this.seed = seed; }
            next() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }
        }

        let state = {
            gameState: 'mode_select',
            isHost: false,
            seed: Math.floor(Math.random() * 1000000),
            playerCount: 15,
            payoutScenarioIdx: Math.floor(Math.random() * PAYOUT_SCENARIOS.length),
            myPrediction: null,
            horses: [],
            winners: [],
            payoutMode: null
        };

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('d');
            if (data) {
                const [s, c, p] = data.split('-').map(Number);
                state.seed = s;
                state.playerCount = c;
                state.payoutScenarioIdx = p;
                state.isHost = false;
                state.gameState = 'guest_waiting';
                render();
            }
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            const container = document.createElement('div');
            container.className = "container";

            if (state.gameState === 'mode_select') {
                container.innerHTML = `
                    <h1 style="font-weight:900;">ç¬¬26å› åˆå¹´ä»¤å’Œãƒ€ãƒ¼ãƒ“ãƒ¼</h1>
                    <p>ç®¡ç†è€…ã‚‚å‚åŠ è€…ã‚‚ã€å…¨å“¡ãŒåŒã˜é‹å‘½ã‚’å…±æœ‰ã—ã¾ã™</p>
                    <div style="margin-top:50px;">
                        <div onclick="initHost()" class="btn btn-primary">å† ä¸»ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ã¨ã—ã¦é–‹å‚¬</div>
                        <div style="margin-top:20px; font-size:0.9rem; opacity:0.7;">å‚åŠ è€…ã¯ãƒ›ã‚¹ãƒˆã®QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
                    </div>
                `;
            }
            else if (state.gameState === 'host_setup') {
                container.innerHTML = `
                    <h2 style="font-weight:900;">é–‹å‚¬æº–å‚™ï¼ˆå† ä¸»ï¼‰</h2>
                    <div style="background:white; padding:15px; border:2px solid var(--primary); text-align:left; margin-bottom:20px;">
                        <p><b>1. é ­æ•°ã‚’æ±ºã‚ã‚‹:</b> 
                            <select onchange="state.playerCount=Number(this.value); updateHostQR(); render();">
                                ${Array.from({ length: 21 }, (_, i) => i + 5).map(n => `<option value="${n}" ${n == state.playerCount ? 'selected' : ''}>${n}é ­ç«‹ã¦</option>`).join('')}
                            </select>
                        </p>
                        <p><b>2. ã‚ãªãŸã®1ç€äºˆæƒ³ï¼š</b></p>
                        <div class="prediction-grid">
                            ${Array.from({ length: state.playerCount }).map((_, i) => `
                                <div onclick="selectPrediction(${i})" class="prediction-item ${state.myPrediction === i ? 'selected' : ''}">
                                    ${i + 1}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <div id="qrcode-container">
                            <p style="font-size:0.8rem; margin-bottom:10px;">å‚åŠ è€…ã«ã“ã®QRã‚’èª­ã¾ã›ã¦ãã ã•ã„</p>
                            <div id="qrcode"></div>
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <p style="font-size:0.8rem; opacity:0.6;">â€»é…å½“ã¨é †ä½ã¯ã‚·ãƒ¼ãƒ‰å€¤ã«åŸºã¥ãè‡ªå‹•æ±ºå®šã•ã‚Œã¾ã™</p>
                        <div onclick="startSyncRace()" class="btn btn-primary">å…¨å“¡æº–å‚™å®Œäº†ãƒ»å‡ºèµ°ï¼</div>
                    </div>
                `;
                setTimeout(() => updateHostQR(), 0);
            }
            else if (state.gameState === 'guest_waiting') {
                container.innerHTML = `
                    <h2 style="font-weight:900;">å‡ºèµ°å¾…æ©Ÿä¸­</h2>
                    <p>${state.playerCount}é ­ç«‹ã¦ã®ãƒ¬ãƒ¼ã‚¹ã«å‚åŠ ã—ã¾ã—ãŸã€‚</p>
                    <hr>
                    <p><b>ã‚ãªãŸã®1ç€äºˆæƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š</b></p>
                    <div class="prediction-grid">
                        ${Array.from({ length: state.playerCount }).map((_, i) => `
                            <div onclick="selectPrediction(${i})" class="prediction-item ${state.myPrediction === i ? 'selected' : ''}">
                                ${i + 1}
                            </div>
                        `).join('')}
                    </div>
                    <p style="font-size:0.8rem; color:var(--accent);">ãƒ›ã‚¹ãƒˆãŒé–‹å§‹ã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„</p>
                    <div onclick="startSyncRace()" class="btn btn-primary">ï¼ˆåˆå›³ã§ï¼‰é–‹å§‹ï¼</div>
                `;
            }
            else if (state.gameState === 'racing') {
                renderRacing(app); return;
            }
            else if (state.gameState === 'finished') {
                renderFinished(container);
            }

            app.appendChild(container);
        }

        function initHost() {
            state.isHost = true;
            state.gameState = 'host_setup';
            render();
        }

        function updateHostQR() {
            const qrEl = document.getElementById('qrcode');
            if (!qrEl) return;
            qrEl.innerHTML = '';
            const baseUrl = window.location.href.split('?')[0];
            const data = `${state.seed}-${state.playerCount}-${state.payoutScenarioIdx}`;
            const fullUrl = `${baseUrl}?d=${data}`;

            new QRCode(qrEl, {
                text: fullUrl,
                width: 180,
                height: 180,
                colorDark: "#3e2723",
                colorLight: "#ffffff"
            });
        }

        function selectPrediction(idx) {
            state.myPrediction = idx;
            render();
        }

        function calculateDistribution(scenario, total) {
            let dist = scenario.ratios.map(r => Math.floor(total * r));
            let currentSum = dist.reduce((a, b) => a + b, 0);
            let diff = total - currentSum;
            for (let i = 0; i < diff; i++) {
                dist[i % 3]++;
            }
            return { ...scenario, dist };
        }

        function startSyncRace() {
            const rng = new SeededRandom(state.seed);
            state.horses = Array.from({ length: state.playerCount }, (_, i) => ({
                id: i,
                name: `é¦¬ç•ª ${i + 1}`,
                position: 0,
                baseSpeed: rng.next() * 0.25 + 0.15,
                strategy: rng.next(),
                finished: false,
                wobble: 0
            }));

            const scenario = PAYOUT_SCENARIOS[state.payoutScenarioIdx];
            state.payoutMode = calculateDistribution(scenario, state.playerCount);

            state.gameState = 'racing';
            render();
            requestAnimationFrame(raceLoop);
        }

        function raceLoop() {
            if (state.gameState !== 'racing') return;

            let allFinished = true;
            state.horses.forEach(h => {
                if (!h.finished) {
                    h.position += h.baseSpeed * 0.8 + (Math.random() * 0.1);
                    if (h.position >= 100) {
                        h.position = 100;
                        h.finished = true;
                    }
                    allFinished = false;
                }
                const el = document.getElementById(`h-${h.id}`);
                if (el) el.style.left = `calc(35px + ${h.position * 0.8}%)`;
            });

            if (allFinished) {
                state.winners = [...state.horses].sort((a, b) => b.baseSpeed - a.baseSpeed).slice(0, 3);
                state.gameState = 'finished';
                setTimeout(render, 1200);
            } else {
                requestAnimationFrame(raceLoop);
            }
        }

        function renderRacing(app) {
            const myPredictionLabel = state.myPrediction !== null ? `ã‚ãªãŸã®äºˆæƒ³ï¼šé¦¬ç•ª ${state.myPrediction + 1}` : 'äºˆæƒ³æœªé¸æŠ';
            app.innerHTML = `
                <div class="race-screen">
                    <div class="race-header">
                        <h2 class="animate-pulse">é‹å‘½ã®åŒæœŸãƒ¬ãƒ¼ã‚¹å®Ÿæ³ä¸­...</h2>
                        <div class="race-info-sub">${myPredictionLabel}</div>
                    </div>
                    <div class="track-area" id="track">
                        <div class="goal-line"></div>
                        ${state.horses.map(h => `
                            <div class="lane">
                                <div class="lane-num">${h.id + 1}</div>
                                <div id="h-${h.id}" class="horse-sprite" style="left: 40px;">
                                    <span class="horse-emoji">ğŸ</span>
                                    <div class="horse-label">${h.id + 1}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderFinished(container) {
            const isWin = state.myPrediction !== null && state.winners[0].id === state.myPrediction;

            container.innerHTML = `
                <h1 style="font-size:3rem;">${isWin ? 'ğŸŠ çš„ä¸­ï¼' : 'çµ‚å¹•'}</h1>
                <p style="font-weight:bold;">${state.isHost ? 'ã€å† ä¸»ã€‘' : 'ã€ä¸€èˆ¬å‚åŠ ã€‘'} ã‚ãªãŸã®äºˆæƒ³: é¦¬ç•ª ${state.myPrediction !== null ? state.myPrediction + 1 : 'ãªã—'}</p>
                
                <div class="payout-card">
                    <h3 style="text-decoration:underline;">ã€ æœ¬æ—¥ã®åˆ†é…ãƒ«ãƒ¼ãƒ«: ${state.payoutMode.name} ã€‘</h3>
                    <p style="font-size:0.8rem; margin-bottom:10px;">${state.payoutMode.desc}</p>
                    <p style="font-size:0.7rem; opacity:0.6;">(å…¨${state.playerCount}æ ã‚’ä»¥ä¸‹ã®é€šã‚Šåˆ†é…ã—ã¾ã—ãŸ)</p>
                    <div style="display:flex; justify-content:space-around; margin:20px 0;">
                        ${state.winners.map((w, i) => `
                            <div style="border:3px solid var(--primary); padding:10px; background:${i == 0 ? '#fffde7' : 'white'}; flex:1; margin:5px;">
                                <div style="font-size:0.8rem;">${i + 1}ç€: é¦¬ç•ª${w.id + 1}</div>
                                <div style="font-size:1.5rem; font-weight:bold;">${state.payoutMode.dist[i]}å€‹</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div onclick="location.href=window.location.href.split('?')[0]" class="btn btn-primary" style="background:var(--primary);">æœ€åˆã«æˆ»ã‚‹</div>
            `;
        }

        window.onload = () => {
            checkUrlParams();
            if (state.gameState === 'mode_select') render();
        };
    </script>
</body>

</html>