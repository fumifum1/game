<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬26å› ä¸™åˆæ¯ãƒ€ãƒ¼ãƒ“ãƒ¼</title>
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/fumifum1/main/main/jpg/ico.ico">
    <style>
        :root {
            --primary: #3e2723;
            --bg-paper: #f4e7d3;
            --accent: #8b0000;
            --track-light: #8d6e63;
            --track-dark: #5d4037;
            --success: #2e7d32;
            --gold: #ffd700;
            --info: #0277bd;
            --btn-border: #3e2723;
        }

        body {
            font-family: "serif", "YuMincho", "Yu Mincho", "MS Mincho", serif;
            background-color: var(--bg-paper);
            color: var(--primary);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            border: 4px solid var(--primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* --- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .hamburger {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 25px;
            cursor: pointer;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hamburger span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: var(--primary);
            transition: all 0.3s;
        }

        .hamburger.open span:nth-child(1) {
            transform: translateY(11px) rotate(45deg);
        }

        .hamburger.open span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.open span:nth-child(3) {
            transform: translateY(-11px) rotate(-45deg);
        }

        #menu-content {
            position: fixed;
            top: 0;
            right: -250px;
            width: 200px;
            height: 100%;
            background-color: var(--bg-paper);
            border-left: 3px solid var(--primary);
            box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            z-index: 1999;
            transition: right 0.3s;
            padding-top: 60px;
        }

        #menu-content.open {
            right: 0;
        }

        #menu-content ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #menu-content li {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(62, 39, 35, 0.1);
        }

        #menu-content a {
            text-decoration: none;
            color: var(--primary);
            font-weight: bold;
            display: block;
        }

        /* --- ãƒ•ãƒƒã‚¿ãƒ¼ ã‚¹ã‚¿ã‚¤ãƒ« --- */
        footer {
            background-color: var(--primary);
            color: var(--bg-paper);
            text-align: center;
            padding: 15px 10px;
            font-size: 0.7rem;
            margin-top: auto;
        }

        footer a {
            color: var(--gold);
            text-decoration: none;
        }

        /* --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px 10px;
            text-align: center;
            flex: 1;
        }

        .main-image {
            width: 100%;
            max-width: 320px;
            height: auto;
            margin: 0 auto 10px auto;
            display: block;
        }

        .image-fallback {
            font-weight: bold;
            font-size: 1.2rem;
            margin: 20px 0;
            color: var(--primary);
        }

        .btn {
            display: inline-block;
            cursor: pointer;
            font-weight: 900;
            border: 2px solid var(--primary);
            padding: 8px 16px;
            margin: 5px;
            background: white;
            font-size: 0.9rem;
            user-select: none;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--success);
            color: white;
            padding: 12px 30px;
            font-size: 1rem;
            box-shadow: 3px 3px 0px #1b5e20;
        }

        .btn-primary:active {
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: #fff;
            width: 100%;
            max-width: 400px;
            padding: 20px;
            border: 2px solid #333;
            text-align: center;
            box-shadow: 10px 10px 0px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .guide-text {
            text-align: left;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .guide-text h3 {
            border-left: 4px solid var(--accent);
            padding-left: 8px;
            margin: 15px 0 5px;
            font-size: 1rem;
        }

        .setup-card {
            background: white;
            border: 2px solid var(--primary);
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 900;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 10px;
            padding-bottom: 3px;
            display: block;
        }

        .name-input-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 5px;
            background: #fafafa;
        }

        .name-input-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            gap: 5px;
        }

        .name-input-item span {
            width: 25px;
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            background: var(--primary);
            color: white;
            border-radius: 2px;
        }

        .name-input-item input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            font-size: 0.85rem;
        }

        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 8px;
            margin: 10px 0;
            justify-content: center;
        }

        .prediction-num {
            border: 2px solid var(--primary);
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
            font-weight: 900;
            font-size: 1.1rem;
            transition: all 0.2s;
        }

        .prediction-num.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .fanfare-screen {
            background-color: var(--primary);
            background-image: linear-gradient(rgba(62, 39, 35, 0.8), rgba(62, 39, 35, 0.8)), url('images/uma.png');
            background-size: 40%;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .fanfare-timer {
            font-size: 6rem;
            font-weight: 900;
            margin: 10px 0;
            color: var(--gold);
            text-shadow: 4px 4px 10px rgba(0,0,0,0.8);
            z-index: 10;
        }

        .race-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .race-header {
            background: var(--primary);
            color: var(--bg-paper);
            padding: 5px 0;
            text-align: center;
            z-index: 100;
            border-bottom: 2px solid #000;
        }

        .my-ticket-badge {
            background: #fff;
            color: var(--primary);
            padding: 2px 12px;
            display: inline-block;
            margin-top: 2px;
            font-size: 0.85rem;
            font-weight: 900;
            border: 1px solid #000;
            border-radius: 20px;
        }

        .track-area {
            flex: 1;
            background-color: var(--track-dark);
            overflow-y: auto;
            position: relative;
        }

        .lane {
            position: relative;
            height: 35px;
            background: var(--track-light);
            border-bottom: 1px solid var(--track-dark);
            display: flex;
            align-items: center;
        }

        .lane-sidebar {
            width: 30px;
            height: 100%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .lane-bg-name {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -55%);
            font-size: 16px;
            font-weight: 900;
            color: #ffffff;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
            text-shadow: 2px 2px 0 var(--primary), -1px -1px 0 var(--primary), 1px -1px 0 var(--primary), -1px 1px 0 var(--primary), 1px 1px 0 var(--primary);
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 10px;
            border-radius: 10px;
        }

        .horse-sprite {
            position: absolute;
            z-index: 50;
            transition: left 0.1s linear;
            display: flex;
            align-items: center;
        }

        .horse-emoji {
            font-size: 24px;
            transform: scaleX(-1);
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
        }

        .goal-line {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            border-left: 2px dashed white;
            background: rgba(255, 255, 255, 0.05);
            z-index: 20;
        }

        @keyframes stamp {
            0% { transform: scale(3); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .reveal-item {
            animation: stamp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .lottery-box {
            background: #e0e0e0;
            border: 4px solid var(--primary);
            padding: 20px;
            font-size: 1.5rem;
            font-weight: 900;
            margin: 20px 0;
            transition: background 0.3s;
        }

        .lottery-box.active {
            background: #fffde7;
        }
    </style>
</head>

<body>

    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="hamburger" id="hamburger-icon" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <nav id="menu-content">
        <ul>
            <li><a href="../main/index.html">Profile</a></li>
            <li><a href="https://fumifum1.github.io/main/game.html">Game</a></li>
            <li style="border-top: 1px solid var(--btn-border); margin: 4px 0; padding: 0;"></li>
            <li><a href="https://fumifum1.github.io/game/derby_h4.html">å† ä¸»ã€Šãƒ›ã‚¹ãƒˆã€‹ãƒ¬ãƒ¼ã‚¹</a></li>
            <li><a href="#" onclick="toggleHelp(); return false;">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</a></li>
        </ul>
    </nav>

    <div id="app"></div>

    <div id="guide-modal" class="modal-overlay" onclick="closeGuide()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 style="border-bottom: 2px solid var(--primary); padding-bottom: 10px;">éŠã³æ–¹ã‚¬ã‚¤ãƒ‰</h2>
            <div class="guide-text">
                <h3>1. é–‹å‚¬æº–å‚™ï¼ˆãƒ›ã‚¹ãƒˆï¼‰</h3>
                <p>ã€Œå† ä¸»ã¨ã—ã¦é–‹å‚¬ã€ã‚’æŠ¼ã—ã€å‡ºèµ°é ­æ•°ã‚’æ±ºã‚ã¾ã™ã€‚å„é¦¬ã«åå‰ã‚’ä»˜ã‘ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</p>
                <h3>2. å‚åŠ è€…ã®æ‹›å¾…</h3>
                <p>ç”»é¢ä¸‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’å‚åŠ è€…ã«èª­ã¿å–ã£ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚å…¨å“¡ãŒåŒã˜è¨­å®šï¼ˆå‡ºèµ°é¦¬ãƒ»åå‰ï¼‰ã§å‚åŠ ã§ãã¾ã™ã€‚</p>
                <h3>3. äºˆæƒ³é¦¬åˆ¸ã®è³¼å…¥</h3>
                <p>è‡ªåˆ†ã®å‹ã¡é¦¬ã‚’1é ­é¸ã³ã€ç•ªå·ã‚’æŠ¼ã™ã¨é¦¬åˆ¸ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚å…¨å“¡ãŒæº–å‚™ã§ããŸã‚‰ã€Œå‡ºèµ°é–‹å§‹ã€ï¼</p>
                <h3>4. é…å½“ã®æŠ½é¸</h3>
                <p>ãƒ¬ãƒ¼ã‚¹çµ‚äº†å¾Œã€ä¸Šä½3é ­ã¸ã®ã€Œé…å½“ãƒ«ãƒ¼ãƒ«ã€ã‚’æŠ½é¸ã—ã¾ã™ã€‚1ä½ç·å–ã‚Šã‹ã€å‡ç­‰åˆ†é…ã‹â€¦é‹å‘½ãŒæ±ºã¾ã‚Šã¾ã™ã€‚</p>
            </div>
            <div onclick="closeGuide()" class="btn btn-primary" style="margin-top: 20px; width: 80%;">é–‰ã˜ã‚‹</div>
        </div>
    </div>

    <div id="ticket-modal" class="modal-overlay" onclick="closeModalForce()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="border-bottom: 2px solid #333; display: flex; justify-content: space-between; font-weight: bold; font-size: 0.7rem; padding-bottom: 5px; margin-bottom: 15px;">
                <span>ç¬¬26å› ä¸™åˆæ¯ãƒ€ãƒ¼ãƒ“ãƒ¼</span>
                <span>å˜å‹</span>
            </div>
            <div id="ticket-num" style="font-size: 3.5rem; font-weight: 900; line-height: 1;">00</div>
            <div id="ticket-name" style="font-size: 1.5rem; font-weight: 900; margin: 15px 0;">---</div>
            <div onclick="startPreRaceSequence()" class="btn btn-primary" style="width: 80%; margin: 0 auto;">å‡ºèµ°é–‹å§‹</div>
        </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer>
        &copy; 2026 Synapse Creations. derby race game_ver4.0.1 <a href="https://fumifum1.github.io/main/index.html">Creator/fumifumi</a>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        /* --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½ --- */
        function toggleMenu() {
            const menu = document.getElementById('menu-content');
            const icon = document.getElementById('hamburger-icon');
            menu.classList.toggle('open');
            icon.classList.toggle('open');
        }

        function toggleHelp() {
            toggleMenu(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            openGuide();  // ã‚¬ã‚¤ãƒ‰ã‚’é–‹ã
        }

        /* --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ --- */
        const sounds = {
            fanfare: new Audio('sounds/1.mp3'),
            gateOpen: new Audio('sounds/2.mp3'),
            running: new Audio('sounds/3.mp3'),
            applause: new Audio('sounds/sound4.mp3'),
            drumroll: new Audio('sounds/5.mp3'),
            finish: new Audio('sounds/6.mp3')
        };

        sounds.gateOpen.volume = 1.0;
        sounds.running.volume = 0.6;
        sounds.fanfare.volume = 0.8;
        sounds.running.loop = true;

        function playSound(key) {
            try {
                sounds[key].currentTime = 0;
                sounds[key].play().catch(e => console.log("Audio play blocked", e));
            } catch (e) { }
        }

        function stopSound(key) {
            try {
                sounds[key].pause();
                sounds[key].currentTime = 0;
            } catch (e) { }
        }

        const LEGEND_HORSES = ["ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ", "ã‚ªã‚°ãƒªã‚­ãƒ£ãƒƒãƒ—", "ãƒˆã‚¦ã‚«ã‚¤ãƒ†ã‚¤ã‚ªãƒ¼", "ã‚µã‚¤ãƒ¬ãƒ³ã‚¹ã‚¹ã‚ºã‚«", "ãƒŠãƒªã‚¿ãƒ–ãƒ©ã‚¤ã‚¢ãƒ³", "ã‚¨ãƒ«ã‚³ãƒ³ãƒ‰ãƒ«ãƒ‘ã‚µãƒ¼", "ã‚·ãƒ³ãƒœãƒªãƒ«ãƒ‰ãƒ«ãƒ•", "ã‚¦ã‚©ãƒƒã‚«", "ãƒ€ã‚¤ãƒ¯ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆ", "ã‚´ãƒ¼ãƒ«ãƒ‰ã‚·ãƒƒãƒ—", "ã‚­ã‚¿ã‚µãƒ³ãƒ–ãƒ©ãƒƒã‚¯", "ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰ã‚¢ã‚¤", "ã‚³ãƒ³ãƒˆãƒ¬ã‚¤ãƒ«", "ã‚¤ã‚¯ã‚¤ãƒãƒƒã‚¯ã‚¹"];
        const HORSE_PREFIXES = ["ã‚µã‚¯ãƒ©", "ãƒ¡ã‚¸ãƒ­", "ãƒˆã‚¦ã‚«ã‚¤", "ã‚·ãƒ³ãƒœãƒª", "ãƒ€ã‚¤ãƒ¯", "ãƒãƒã‚«ãƒ", "ã‚¢ã‚°ãƒã‚¹", "ãƒãƒ³ãƒãƒƒã‚¿ãƒ³", "ã‚¢ãƒ‰ãƒã‚¤ãƒ¤", "ã‚¹ãƒãƒ¼ãƒˆ", "ã‚´ãƒ¼ãƒ«ãƒ‰", "ã‚­ãƒ³ã‚°", "ãƒŠãƒªã‚¿"];
        const HORSE_SUFFIXES = ["ãƒã‚¯ã‚·ãƒ³ã‚ªãƒ¼", "ãƒãƒƒã‚¯ã‚¤ãƒ¼ãƒ³", "ãƒ†ã‚¤ã‚ªãƒ¼", "ã‚ªãƒ¼ã‚·ãƒ£ãƒ³", "ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆ", "ãƒ•ã‚¯ã‚­ã‚¿ãƒ«", "ã‚¿ã‚­ã‚ªãƒ³", "ã‚«ãƒ•ã‚§", "ãƒ™ã‚¬", "ãƒ•ã‚¡ãƒ«ã‚³ãƒ³", "ã‚·ãƒƒãƒ—", "ã‚«ãƒ¡ãƒãƒ¡ãƒ", "ã‚¿ã‚¤ã‚·ãƒ³"];

        function generateHorseName(index) {
            if (index < LEGEND_HORSES.length && Math.random() > 0.3) return LEGEND_HORSES[index];
            const pre = HORSE_PREFIXES[Math.floor(Math.random() * HORSE_PREFIXES.length)];
            const suf = HORSE_SUFFIXES[Math.floor(Math.random() * HORSE_SUFFIXES.length)];
            return pre + suf;
        }

        const PAYOUT_SCENARIOS = [
            { id: 0, name: "ä¸€æ”«åƒé‡‘", ratios: [1.0, 0, 0], desc: "1ä½ãŒå…¨ã¦ã®æ ã‚’ç‹¬å " },
            { id: 1, name: "å¾¡ä¸‰å®¶ãƒ»ç­‰åˆ†", ratios: [0.34, 0.33, 0.33], desc: "ä¸Šä½3åã§å‡ç­‰ã«åˆ†é…" },
            { id: 2, name: "å®ŸåŠ›ä¸»ç¾©", ratios: [0.6, 0.25, 0.15], desc: "ä¼çµ±çš„ãªå‚¾æ–œé…åˆ†" },
            { id: 3, name: "ä¸‹å‰‹ä¸Š", ratios: [0.1, 0.5, 0.4], desc: "2ä½ãƒ»3ä½ã«æ‰‹åšã„ï¼" },
            { id: 4, name: "æ··æ²Œï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰", ratios: null, desc: "é…åˆ†ã¯ç¥ã®ã¿çŸ¥ã‚‹" }
        ];

        class SeededRandom {
            constructor(seed) { this.seed = seed; }
            next() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }
        }

        let state = {
            gameState: 'mode_select',
            isHost: false,
            seed: Math.floor(Math.random() * 1000000),
            playerCount: 15,
            payoutScenarioIdx: Math.floor(Math.random() * PAYOUT_SCENARIOS.length),
            myPrediction: null,
            horses: [],
            winners: [],
            payoutMode: null,
            horseNames: [],
            isLotterySpinning: false,
            countdown: 7
        };

        function initHorseNames(count) {
            const currentNames = [...state.horseNames];
            state.horseNames = Array.from({ length: count }, (_, i) => currentNames[i] || generateHorseName(i));
        }

        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            app.innerHTML = '';
            const container = document.createElement('div');
            container.className = "container";

            if (state.gameState === 'mode_select') {
                container.innerHTML = `
                    <h1 style="font-weight:900; font-size:1.5rem; margin:30px 0 10px 0;">ç¬¬26å› ä¸™åˆæ¯ãƒ€ãƒ¼ãƒ“ãƒ¼</h1>
                    <div id="main-image-container">
                        <img src="images/uma.png" alt="ç«¶é¦¬ãƒ­ã‚´" class="main-image" onerror="showFallbackText(this)">
                    </div>
                    <p style="margin: 10px 0 30px 0; font-weight: bold;">ä¼çµ±ã¨æ „å…‰ã®ãƒ¬ãƒ¼ã‚¹ãŒä»Šã€å§‹ã¾ã‚‹ã€‚</p>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                        <div onclick="initHost()" class="btn btn-primary">å† ä¸»ã¨ã—ã¦é–‹å‚¬</div>
                        <div onclick="openGuide()" class="btn btn-outline" style="font-size: 0.8rem; border-color: #ccc;">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</div>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 20px;">â€»éŸ³éŸ¿åŠ¹æœãŒé³´ã‚Šã¾ã™ã€‚ã”æ³¨æ„ãã ã•ã„ã€‚</p>
                    </div>
                `;
            }
            else if (state.gameState === 'host_setup') {
                const headerText = state.isHost ? "é–‹å‚¬æº–å‚™" : "æº–å‚™å®Œäº†ï¼ˆã‚²ã‚¹ãƒˆå‚åŠ ä¸­ï¼‰";
                container.innerHTML = `
                    <h2 style="font-size:1.2rem; margin-bottom:15px;">${headerText}</h2>
                    ${state.isHost ? `
                    <div class="setup-card">
                        <span class="section-title">1. å‡ºèµ°é ­æ•°è¨­å®š</span>
                        <select onchange="handleCountChange(this.value)" style="width:100%; padding:8px;">
                            ${Array.from({ length: 26 }, (_, i) => i + 5).map(n => `<option value="${n}" ${n == state.playerCount ? 'selected' : ''}>${n}é ­ç«‹ã¦</option>`).join('')}
                        </select>
                    </div>
                    <div class="setup-card">
                        <span class="section-title">2. å‡ºèµ°é¦¬åç°¿</span>
                        <div class="name-input-list">
                            ${state.horseNames.map((name, i) => `
                                <div class="name-input-item">
                                    <span>${i + 1}</span>
                                    <input type="text" value="${name}" onchange="updateHorseName(${i}, this.value)">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="setup-card">
                        <span class="section-title">ãƒ¬ãƒ¼ã‚¹è¨­å®š</span>
                        <p style="font-size:0.9rem; margin:0;">${state.playerCount}é ­ç«‹ã¦ã®ãƒ¬ãƒ¼ã‚¹ã«å‚åŠ ã—ã¾ã—ãŸã€‚</p>
                    </div>
                    `}
                    <div class="setup-card">
                        <span class="section-title">äºˆæƒ³é¦¬åˆ¸ã®é¸æŠ</span>
                        <div class="prediction-grid">
                            ${state.horseNames.map((_, i) => `
                                <div onclick="selectPrediction(${i})" class="prediction-num ${state.myPrediction === i ? 'selected' : ''}">
                                    ${i + 1}
                                </div>
                            `).join('')}
                        </div>
                        <p style="font-size:0.8rem; color:#666; text-align:center; margin-top:10px;">å‹ã¡é¦¬ã®ç•ªå·ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
                    </div>
                    ${state.isHost ? `
                    <div class="setup-card" style="text-align:center;">
                        <span class="section-title">æ‹›å¾…QRï¼ˆã‚¹ã‚­ãƒ£ãƒ³ã—ã¦å‚åŠ ï¼‰</span>
                        <div id="qrcode" style="display:inline-block; border:2px solid #000; padding:10px; background:#fff;"></div>
                    </div>
                    ` : ''}
                `;
                if (state.isHost) setTimeout(() => updateHostQR(), 0);
            }
            else if (state.gameState === 'pre_race') { renderPreRace(app); return; }
            else if (state.gameState === 'racing') { renderRacing(app); return; }
            else if (state.gameState === 'reveal_ranks') { renderRankReveal(container); }
            else if (state.gameState === 'lottery') { renderLottery(container); }
            else if (state.gameState === 'finished') { renderFinished(container); }

            app.appendChild(container);
        }

        function showFallbackText(img) {
            const container = img.parentElement;
            container.innerHTML = '<div class="image-fallback">ç«¶é¦¬ãƒ­ã‚´</div>';
        }

        function openGuide() { document.getElementById('guide-modal').style.display = 'flex'; }
        function closeGuide() { document.getElementById('guide-modal').style.display = 'none'; }

        function initHost() { 
            state.isHost = true; 
            state.gameState = 'host_setup'; 
            initHorseNames(state.playerCount); 
            render(); 
        }

        function handleCountChange(val) { 
            state.playerCount = Number(val); 
            initHorseNames(state.playerCount); 
            render(); 
        }

        function updateHorseName(idx, val) { state.horseNames[idx] = val; }

        function updateHostQR() {
            const qrEl = document.getElementById('qrcode');
            if (!qrEl) return;
            qrEl.innerHTML = '';
            const baseUrl = window.location.href.split('?')[0];
            const data = `${state.seed}-${state.playerCount}-${state.payoutScenarioIdx}`;
            new QRCode(qrEl, { text: `${baseUrl}?d=${data}`, width: 140, height: 140 });
        }

        function selectPrediction(idx) {
            state.myPrediction = idx;
            document.getElementById('ticket-num').innerText = (idx + 1).toString().padStart(2, '0');
            document.getElementById('ticket-name').innerText = state.horseNames[idx];
            document.getElementById('ticket-modal').style.display = 'flex';
        }

        function closeModalForce() { 
            document.getElementById('ticket-modal').style.display = 'none'; 
            render(); 
        }

        function startPreRaceSequence() {
            closeModalForce();
            state.gameState = 'pre_race';
            state.countdown = 7;
            render();
            playSound('fanfare');
            const timer = setInterval(() => {
                state.countdown--;
                if (state.countdown <= 0) {
                    clearInterval(timer);
                    startRace();
                } else { render(); }
            }, 1000);
        }

        function renderPreRace(app) {
            app.innerHTML = `
                <div class="fanfare-screen">
                    <div style="font-size:1.5rem; font-weight:bold; text-shadow: 2px 2px 4px #000; z-index:10;">å‡ºèµ°ã¾ã§...</div>
                    <div class="fanfare-timer">${state.countdown}</div>
                    <div style="font-size:0.9rem; opacity: 0.8; z-index:10;">ä¼çµ±ã¨æ „å…‰ã®ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬</div>
                </div>
            `;
        }

        function startRace() {
            playSound('gateOpen');
            setTimeout(() => { playSound('running'); }, 100);
            const rng = new SeededRandom(state.seed);
            state.horses = Array.from({ length: state.playerCount }, (_, i) => ({
                id: i, name: state.horseNames[i], position: 0,
                baseSpeed: rng.next() * 0.22 + 0.18, finished: false
            }));
            state.gameState = 'racing';
            render();
            requestAnimationFrame(raceLoop);
        }

        function raceLoop() {
            if (state.gameState !== 'racing') return;
            let allFinished = true;
            state.horses.forEach(h => {
                if (!h.finished) {
                    h.position += h.baseSpeed * 0.7 + (Math.random() * 0.12);
                    if (h.position >= 100) { h.position = 100; h.finished = true; }
                    allFinished = false;
                }
                const el = document.getElementById(`h-${h.id}`);
                if (el) el.style.left = `calc(30px + ${h.position * 0.85}%)`;
            });
            if (allFinished) {
                stopSound('running');
                playSound('applause');
                state.winners = [...state.horses].sort((a, b) => b.baseSpeed - a.baseSpeed).slice(0, 3);
                state.gameState = 'reveal_ranks';
                setTimeout(render, 500);
            } else { requestAnimationFrame(raceLoop); }
        }

        function renderRacing(app) {
            const myNum = (state.myPrediction + 1).toString().padStart(2, '0');
            const myName = state.horseNames[state.myPrediction];
            app.innerHTML = `
                <div class="race-screen">
                    <div class="race-header">
                        <div style="font-size:0.8rem; font-weight:bold; letter-spacing: 0.1em;">å®Ÿæ³ï¼šç¬¬26å› ä¸™åˆæ¯ãƒ€ãƒ¼ãƒ“ãƒ¼</div>
                        <div class="my-ticket-badge">ã‚ãªãŸã®é¦¬åˆ¸ï¼š${myNum} ${myName}</div>
                    </div>
                    <div class="track-area">
                        <div class="goal-line"></div>
                        ${state.horses.map(h => `<div class="lane"><div class="lane-sidebar">${h.id + 1}</div><div class="lane-bg-name">${h.name}</div><div id="h-${h.id}" class="horse-sprite" style="left: 30px;"><span class="horse-emoji">ğŸ</span></div></div>`).join('')}
                    </div>
                </div>
            `;
        }

        function renderRankReveal(container) {
            container.innerHTML = `
                <h2 style="font-size:1.2rem; margin:20px 0; border-bottom:2px solid var(--primary);">ç€é †ç¢ºå®š</h2>
                <div style="margin-bottom:30px;">
                    ${state.winners.map((w, i) => `
                        <div class="reveal-item" style="animation-delay:${i * 0.6}s; background:white; border:2px solid var(--primary); padding:15px; margin:10px auto; max-width:400px; display:flex; align-items:center; gap:15px;">
                            <span style="font-size:2rem;">${i == 0 ? 'ğŸ¥‡' : i == 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}</span>
                            <div style="text-align:left;">
                                <div style="font-size:0.8rem; font-weight:bold;">${i + 1}ç€ï¼š${w.id + 1}ç•ª</div>
                                <div style="font-size:1.4rem; font-weight:900;">${w.name}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div onclick="startLottery()" class="btn btn-primary" style="animation: stamp 0.5s 2s forwards; opacity:0;">é…å½“æŠ½é¸ã¸é€²ã‚€</div>
            `;
        }

        function startLottery() {
            state.gameState = 'lottery'; 
            state.isLotterySpinning = true; 
            render();
            playSound('drumroll');
            let count = 0; 
            const max = 37;
            const interval = setInterval(() => {
                state.payoutScenarioIdx = (state.payoutScenarioIdx + 1) % PAYOUT_SCENARIOS.length;
                render(); 
                count++;
                if (count >= max) {
                    clearInterval(interval);
                    stopSound('drumroll');
                    playSound('finish');
                    state.isLotterySpinning = false;
                    state.payoutMode = calculateDistribution(PAYOUT_SCENARIOS[state.payoutScenarioIdx], state.playerCount);
                    render();
                }
            }, 80);
        }

        function calculateDistribution(scenario, total) {
            let dist = [0, 0, 0];
            if (scenario.id === 4) {
                let r1 = Math.floor(Math.random() * total);
                let r2 = Math.floor(Math.random() * (total - r1));
                dist = [r1, r2, total - r1 - r2];
            } else {
                dist = scenario.ratios.map(r => Math.floor(total * r));
                let diff = total - dist.reduce((a, b) => a + b, 0);
                for (let i = 0; i < diff; i++) dist[i % 3]++;
            }
            return { ...scenario, dist };
        }

        function renderLottery(container) {
            const current = PAYOUT_SCENARIOS[state.payoutScenarioIdx];
            container.innerHTML = `
                <h2 style="font-size:1.2rem; margin:20px 0;">é…å½“è¦å®š æŠ½é¸ä¸­</h2>
                <div class="lottery-box ${!state.isLotterySpinning ? 'active' : ''}">${current.name}</div>
                <p>${!state.isLotterySpinning ? current.desc : 'è¦å®šã‚’å¯©è­°ä¸­...'}</p>
                ${!state.isLotterySpinning ? `<div onclick="state.gameState='finished'; render();" class="btn btn-primary">æœ€çµ‚æ²ç¤ºæ¿ã¸</div>` : ''}
            `;
        }

        function renderFinished(container) {
            const isWin = state.myPrediction !== null && state.winners[0].id === state.myPrediction;
            container.innerHTML = `
                <h2 style="font-size:1.8rem; margin:20px 0;">${isWin ? 'ğŸŠ äºˆæƒ³çš„ä¸­ï¼' : 'çµ‚å¹•'}</h2>
                <div style="background: white; border: 2px dashed var(--accent); padding: 12px; margin-bottom: 20px; display: inline-block;">
                    <div style="font-size: 0.75rem; color: var(--accent);">ã‚ãªãŸã®äºˆæƒ³é¦¬åˆ¸</div>
                    <div style="font-size: 1.3rem; font-weight: 900;">${state.myPrediction + 1}ç•ª ${state.horseNames[state.myPrediction]}</div>
                </div>
                <div class="payout-card">
                    <div style="display:flex; justify-content:space-around; gap:8px;">
                        ${state.winners.map((w, i) => `
                            <div style="border:2px solid var(--primary); padding:8px; background:${i == 0 ? '#fffde7' : 'white'}; flex:1; display:flex; flex-direction:column; align-items:center;">
                                <div style="font-size:0.75rem;">${i + 1}ç€</div>
                                <div style="font-size:2rem; font-weight:900; line-height: 1;">${w.id + 1}ç•ª</div>
                                <div style="font-size:0.65rem; white-space:nowrap; overflow:hidden; width:100%; text-align:center;">${w.name}</div>
                                <div style="margin-top:8px; font-size:1.1rem; font-weight:900; color:var(--accent);">${state.payoutMode.dist[i]}æ </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div onclick="location.reload()" class="btn btn-primary" style="margin-top:25px;">æ–°ã—ã„ãƒ¬ãƒ¼ã‚¹</div>
            `;
        }

        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('d')) {
                const [s, c, p] = params.get('d').split('-').map(Number);
                state.seed = s; 
                state.playerCount = c; 
                state.payoutScenarioIdx = p;
                state.isHost = false; 
                state.gameState = 'host_setup'; 
            }
            initHorseNames(state.playerCount); 
            render();
        });
    </script>
</body>

</html>