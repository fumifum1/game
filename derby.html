<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬15å› æ˜­å’Œå¤§æ­£ãƒ€ãƒ¼ãƒ“ãƒ¼</title>
    <style>
        /* --- æ¨™æº–CSSã«ã‚ˆã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³æ§‹ç¯‰ --- */
        :root {
            --primary: #3e2723;
            --bg-paper: #f4e7d3;
            --accent: #8b0000;
            --track-light: #8d6e63;
            --track-dark: #5d4037;
            --success: #2e7d32;
        }

        body {
            font-family: "serif", "YuMincho", "Yu Mincho", "MS Mincho", serif;
            background-color: var(--bg-paper);
            color: var(--primary);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            border: 8px solid var(--primary);
            min-height: 100vh;
            box-sizing: border-box;
        }

        @media (min-width: 768px) {
            body { border-width: 12px; }
        }

        /* å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }

        .btn {
            display: inline-block;
            cursor: pointer;
            font-weight: 900;
            text-decoration: none;
            transition: all 0.2s;
            border: 4px solid var(--primary);
        }

        .btn-primary {
            background-color: var(--success);
            color: white;
            padding: 15px 40px;
            font-size: 1.5rem;
            box-shadow: 4px 4px 0px #1b5e20;
        }

        .btn-primary:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ */
        .setup-header {
            border-bottom: 2px solid var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
        }

        .setup-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(62, 39, 35, 0.05);
            border: 1px dashed var(--primary);
        }

        .player-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            background: rgba(255,255,255,0.4);
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 30px;
        }

        @media (min-width: 640px) { .player-grid { grid-template-columns: 1fr 1fr; } }
        @media (min-width: 1024px) { .player-grid { grid-template-columns: 1fr 1fr 1fr; } }

        .player-input-wrap {
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(62, 39, 35, 0.3);
            padding-bottom: 4px;
        }

        .player-num {
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            margin-right: 8px;
            border-radius: 2px;
        }

        .player-input {
            background: transparent;
            border: none;
            outline: none;
            font-weight: bold;
            font-size: 14px;
            width: 100%;
            color: var(--primary);
        }

        /* ãƒ¬ãƒ¼ã‚¹ç”»é¢ */
        .race-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .race-header {
            background: var(--primary);
            color: var(--bg-paper);
            padding: 10px;
            text-align: center;
        }

        .track-area {
            flex: 1;
            background-color: var(--track-dark);
            overflow-y: auto;
            position: relative;
            padding: 20px 0;
        }

        .lane {
            position: relative;
            height: 40px;
            background: var(--track-light);
            border-bottom: 1px solid var(--track-dark);
            display: flex;
            align-items: center;
        }

        .lane-num {
            width: 30px;
            height: 100%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 12px;
            z-index: 10;
        }

        .horse-sprite {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 20;
            transition: left 0.1s linear;
        }

        .horse-emoji {
            font-size: 28px;
            transform: scaleX(-1);
        }

        .horse-label {
            background: rgba(255,255,255,0.9);
            border: 1px solid var(--primary);
            padding: 0 4px;
            font-size: 10px;
            font-weight: 900;
            white-space: nowrap;
        }

        .goal-line {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            background: rgba(255,255,255,0.1);
            border-left: 4px dashed white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .goal-text {
            writing-mode: vertical-rl;
            color: white;
            font-weight: 900;
            opacity: 0.3;
        }

        /* æŠ½é¸ç”»é¢ */
        .payout-card {
            background: white;
            border: 4px solid var(--primary);
            padding: 30px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.1);
        }

        .payout-spinning { background: #e0e0e0; }
        .payout-fixed { background: #fffde7; }

        .dist-row {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            margin: 20px 0;
        }

        .dist-box {
            border: 2px solid var(--primary);
            padding: 10px;
            min-width: 60px;
            background: white;
        }

        .dist-box.gold { background: #ffd700; }

        /* çµæœç”»é¢ */
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 3px solid var(--primary);
            background: white;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 4px 4px 0 var(--primary);
        }

        .rank-gold { background: #fffde7; border-width: 4px; }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .animate-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div id="app"></div>

    <script>
        // æ¯”ç‡ãƒ™ãƒ¼ã‚¹ã®é…å½“ã‚·ãƒŠãƒªã‚ª
        const PAYOUT_SCENARIOS = [
            { name: "ä¸€æ”«åƒé‡‘ï¼ˆç·å–ã‚Šï¼‰", ratios: [1.0, 0, 0], desc: "å‹åˆ©ã—ãŸä¸€é ­ãŒã€ã™ã¹ã¦ã®æ „èª‰ã‚’ç‹¬å ã™ã‚‹ç©¶æ¥µã®å‹è² ã€‚" },
            { name: "å¾¡ä¸‰å®¶ãƒ»ç­‰åˆ†", ratios: [0.34, 0.33, 0.33], desc: "ä¸Šä½3åãŒã»ã¼å‡ç­‰ã«åˆ†ã‘åˆã†ã€å…¬å¹³ãªã‚‹åˆ†é…ã€‚" },
            { name: "å®ŸåŠ›ä¸»ç¾©ãƒ»å‚¾æ–œé…åˆ†", ratios: [0.6, 0.25, 0.15], desc: "1ä½ã«éåŠæ•°ã€2ä½ãƒ»3ä½ã«ã‚‚å ±ã„ã‚‹ä¼çµ±çš„é…åˆ†ã€‚" },
            { name: "å¤§ç›¤æŒ¯ã‚‹èˆã„", ratios: [0.45, 0.35, 0.2], desc: "1ä½ã‹ã‚‰3ä½ã¾ã§ã€æ™¯æ°—ã‚ˆãåˆ†ã‘åˆã†ç¥å®´ã®è¨­å®šã€‚" },
            { name: "çœŸå‰£å‹è² ï¼ˆäºŒå¼·ï¼‰", ratios: [0.65, 0.35, 0], desc: "1ä½ã¨2ä½ã®ã¿ãŒæœå®Ÿã‚’æ‰‹ã«ã™ã‚‹ã€å³ã—ã„å‹è² ã®ä¸–ç•Œã€‚" },
        ];

        let state = {
            gameState: 'setup',
            playerCount: 15,
            players: Array.from({ length: 15 }, (_, i) => `å‡ºèµ°è€… ${String(i + 1).padStart(2, '0')}`),
            horses: [],
            winners: [],
            payoutMode: null, // è¨ˆç®—æ¸ˆã¿ã®å…·ä½“çš„ãªåˆ†é…æ•°ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            payoutSpinning: false
        };

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            switch(state.gameState) {
                case 'setup': renderSetup(); break;
                case 'racing': renderRacing(); break;
                case 'rank_reveal': renderRankReveal(); break;
                case 'payout_lottery': renderPayout(); break;
                case 'finished': renderFinished(); break;
            }
        }

        function updatePlayerCount(newCount) {
            state.playerCount = parseInt(newCount);
            // æ—¢å­˜ã®å…¥åŠ›ã‚’ä¿æŒã—ã¤ã¤é…åˆ—ã‚µã‚¤ã‚ºã‚’èª¿æ•´
            const newPlayers = Array.from({ length: state.playerCount }, (_, i) => {
                return state.players[i] || `å‡ºèµ°è€… ${String(i + 1).padStart(2, '0')}`;
            });
            state.players = newPlayers;
            render();
        }

        function renderSetup() {
            const app = document.getElementById('app');
            const div = document.createElement('div');
            div.className = "container";
            div.innerHTML = `
                <div class="setup-header">
                    <h1 style="font-size: 2.5rem; font-weight: 900; margin-bottom: 5px;">ç¬¬15å› æ˜­å’Œå¤§æ­£ãƒ€ãƒ¼ãƒ“ãƒ¼</h1>
                    <p style="font-weight: bold;">â€• æœ¬æ—¥ã®å‡ºèµ°é¦¬ç™»éŒ² â€•</p>
                </div>
                <div class="setup-controls">
                    <label style="font-weight: bold; margin-right: 10px;">å‡ºèµ°é ­æ•°ã‚’é¸æŠ:</label>
                    <select onchange="updatePlayerCount(this.value)" style="font-family: serif; padding: 5px; font-weight: bold;">
                        ${Array.from({length: 21}, (_, i) => i + 5).map(n => 
                            `<option value="${n}" ${n === state.playerCount ? 'selected' : ''}>${n}é ­ç«‹ã¦</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="player-grid" id="grid"></div>
                <div onclick="startRace()" class="btn btn-primary">ğŸ å®Ÿæ³é–‹å§‹ï¼å‡ºèµ°ï¼ï¼</div>
            `;
            const grid = div.querySelector('#grid');
            state.players.forEach((p, i) => {
                const wrap = document.createElement('div');
                wrap.className = "player-input-wrap";
                wrap.innerHTML = `<span class="player-num">${i+1}</span>`;
                const input = document.createElement('input');
                input.className = "player-input";
                input.value = p;
                input.oninput = (e) => state.players[i] = e.target.value;
                wrap.appendChild(input);
                grid.appendChild(wrap);
            });
            app.appendChild(div);
        }

        function renderRacing() {
            const app = document.getElementById('app');
            const div = document.createElement('div');
            div.className = "race-screen";
            div.innerHTML = `
                <div class="race-header"><h2 class="animate-pulse" style="font-weight: 900; letter-spacing: 4px;">æ¿€é—˜ï¼å¤§æ­£ç‰¹åˆ¥ãƒ¬ãƒ¼ã‚¹</h2></div>
                <div class="track-area" id="track">
                    <div class="goal-line"><span class="goal-text">GOAL ğŸ</span></div>
                </div>
            `;
            const track = div.querySelector('#track');
            state.horses.forEach(h => {
                const lane = document.createElement('div');
                lane.className = "lane";
                lane.innerHTML = `
                    <div class="lane-num">${h.id+1}</div>
                    <div id="h-${h.id}" class="horse-sprite" style="left: 40px;">
                        <span class="horse-emoji">ğŸ</span>
                        <div class="horse-label">${h.name}</div>
                    </div>
                `;
                track.appendChild(lane);
            });
            app.appendChild(div);
        }

        function renderRankReveal() {
            const app = document.getElementById('app');
            const div = document.createElement('div');
            div.className = "container";
            div.style.paddingTop = "10vh";
            div.innerHTML = `
                <h2 style="font-weight: 900; font-size: 1.5rem; text-decoration: underline; margin-bottom: 40px;">ã€ é€Ÿå ±ï¼šç¢ºå®šç€é † ã€‘</h2>
                <div style="max-width: 500px; margin: 0 auto 40px auto;">
                    ${state.winners.map((w, i) => `
                        <div class="fade-in" style="display: flex; justify-content: space-between; border-bottom: 3px solid var(--primary); padding: 10px; animation-delay: ${i*300}ms">
                            <span style="font-size: 2rem;">${i==0?'ğŸ¥‡':i==1?'ğŸ¥ˆ':'ğŸ¥‰'} <b>${w.name}</b></span>
                            <span style="font-style: italic; font-weight: bold;">${i+1}ä½</span>
                        </div>
                    `).join('')}
                </div>
                <div onclick="spinPayout()" class="btn" style="background: var(--accent); color: white; padding: 15px 30px; font-size: 1.2rem;">âš–ï¸ é…å½“æŠ½é¸ã¸</div>
            `;
            app.appendChild(div);
        }

        function renderPayout() {
            const app = document.getElementById('app');
            const div = document.createElement('div');
            div.className = "container";
            div.style.paddingTop = "10vh";
            
            const isSpinning = state.payoutSpinning;
            const mode = state.payoutMode;

            div.innerHTML = `
                <h2 style="font-weight: 900; margin-bottom: 20px;">ã€ åˆ†é…è¦å®šã®æŠ½é¸ ã€‘</h2>
                <div class="payout-card ${isSpinning?'payout-spinning':'payout-fixed'}">
                    ${mode ? `
                        <h3 style="font-size: 2rem; font-weight: 900; text-decoration: underline;">${mode.name}</h3>
                        <div class="dist-row">
                            ${mode.dist.map((d, i) => `
                                <div>
                                    <div style="font-size: 10px; font-weight: bold;">${i+1}ç­‰</div>
                                    <div class="dist-box ${i==0?'gold':''}">
                                        <b style="font-size: 1.5rem;">${d}</b><small>/${state.playerCount}</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <p style="font-size: 12px; font-style: italic; border-top: 1px dotted var(--primary); pt: 10px;">${mode.desc}</p>
                    ` : `<div class="animate-pulse" style="font-weight: 900; color: var(--accent);">å¯©è­°ä¸­...</div>`}
                </div>
                ${!isSpinning ? `<div onclick="state.gameState='finished';render();" class="btn btn-primary" style="background: var(--primary);">ğŸ“‹ æœ€çµ‚æ²ç¤ºæ¿ã‚’è¡¨ç¤º</div>` : ''}
            `;
            app.appendChild(div);
        }

        function renderFinished() {
            const app = document.getElementById('app');
            const div = document.createElement('div');
            div.className = "container";
            div.innerHTML = `
                <p style="color: var(--accent); font-weight: 900; letter-spacing: 5px; margin-top: 30px;">â€• æœ€çµ‚çµæœå…¬ç¤º â€•</p>
                <h1 style="font-size: 2.5rem; font-weight: 900; margin-bottom: 30px;">æ „å…‰ã®å‹è€…ãŸã¡</h1>
                <div style="max-width: 800px; margin: 0 auto;">
                    ${state.winners.map((w, i) => `
                        <div class="result-item ${i==0?'rank-gold':''}" style="opacity: ${state.payoutMode.dist[i]==0?0.5:1}">
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <span style="font-size: ${i==0?'4rem':'2rem'};">${i==0?'ğŸ¥‡':i==1?'ğŸ¥ˆ':'ğŸ¥‰'}</span>
                                <div style="text-align: left;">
                                    <small style="color: #666;">${i+1}ç­‰è³</small>
                                    <div style="font-size: 1.5rem; font-weight: 900;">${w.name}</div>
                                </div>
                            </div>
                            <div style="border: 2px solid var(--primary); padding: 5px 15px; background: ${i==0?'var(--primary)':'#eee'}; color: ${i==0?'white':'black'};">
                                <small>ç²å¾—</small>
                                <div style="font-size: 1.5rem; font-weight: 900;">${state.payoutMode.dist[i]}<small>/${state.playerCount}</small></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div onclick="resetGame()" class="btn" style="margin-top: 40px; padding: 10px 20px; border-width: 2px;">ğŸ”„ æ¬¡æˆ¦ã€é–‹å‚¬æº–å‚™</div>
            `;
            app.appendChild(div);
        }

        // --- ãƒ­ã‚¸ãƒƒã‚¯ ---

        function startRace() {
            state.horses = state.players.map((name, index) => ({
                id: index, name: name, position: 0,
                baseSpeed: Math.random() * 0.2 + 0.15,
                strategy: Math.random(),
                finished: false, wobble: 0
            }));
            state.gameState = 'racing';
            render();
            requestAnimationFrame(raceLoop);
        }

        function raceLoop() {
            if (state.gameState !== 'racing') return;
            let currentRank = state.horses.filter(h => h.finished).length + 1;
            
            state.horses.forEach(h => {
                if (!h.finished) {
                    const phase = h.position / 100;
                    const bonus = (h.strategy < 0.5) ? (phase < 0.5 ? 0.1 : -0.05) : (phase > 0.6 ? 0.15 : -0.05);
                    const spirit = Math.random() > 0.97 ? 1.2 : (Math.random() * 0.4);
                    h.position += (h.baseSpeed + bonus + spirit) * 0.6;
                    h.wobble = Math.sin(Date.now() / (100 + (h.id * 10))) * 2;
                    if (h.position >= 100) { h.position = 100; h.finished = true; h.rank = currentRank++; }
                }
                const el = document.getElementById(`h-${h.id}`);
                if (el) {
                    el.style.left = `calc(35px + ${h.position * 0.75}%)`;
                    el.style.transform = `translateY(${h.wobble}px)`;
                }
            });

            if (Math.max(...state.horses.map(h => h.position)) >= 96) {
                state.winners = [...state.horses].sort((a,b) => b.position - a.position).slice(0,3);
                state.gameState = 'rank_reveal';
                setTimeout(render, 1200);
            } else {
                requestAnimationFrame(raceLoop);
            }
        }

        function calculateDistribution(scenario, total) {
            // æ¯”ç‡ã«åŸºã¥ã„ã¦äººæ•°ã‚’å‰²ã‚ŠæŒ¯ã‚Šã€åˆè¨ˆãŒtotalã«ä¸€è‡´ã™ã‚‹ã‚ˆã†ã«èª¿æ•´
            let dist = scenario.ratios.map(r => Math.floor(total * r));
            let currentSum = dist.reduce((a, b) => a + b, 0);
            
            // ç«¯æ•°ã‚’1ä½ã«è¿½åŠ ã—ã¦åˆè¨ˆã‚’åˆã‚ã›ã‚‹
            if (currentSum < total) {
                dist[0] += (total - currentSum);
            }
            return { ...scenario, dist };
        }

        function spinPayout() {
            state.gameState = 'payout_lottery';
            state.payoutSpinning = true;
            render();
            let count = 0;
            const interval = setInterval(() => {
                const rawScenario = PAYOUT_SCENARIOS[Math.floor(Math.random() * PAYOUT_SCENARIOS.length)];
                state.payoutMode = calculateDistribution(rawScenario, state.playerCount);
                render();
                if (++count > 20) {
                    clearInterval(interval);
                    state.payoutSpinning = false;
                    render();
                }
            }, 100);
        }

        function resetGame() {
            state.gameState = 'setup';
            state.payoutMode = null;
            state.winners = [];
            render();
        }

        window.onload = render;
    </script>
</body>
</html>