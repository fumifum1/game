<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudoku AI Solver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        @keyframes scan-line {
            0% { transform: translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(288px); opacity: 0; }
        }
        .scanner-line {
            height: 3px;
            background: linear-gradient(to right, transparent, #6366f1, transparent);
            box-shadow: 0 0 15px #6366f1;
            animation: scan-line 2.5s linear infinite;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const App = () => {
            const [grid, setGrid] = useState(Array.from({ length: 9 }, () => Array(9).fill(0)));
            const [selectedCell, setSelectedCell] = useState(null);
            const [solvedGrid, setSolvedGrid] = useState(null);
            const [isCameraActive, setIsCameraActive] = useState(false);
            const [isSolving, setIsSolving] = useState(false);
            const [isScanning, setIsScanning] = useState(false);
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_sudoku_key') || '');
            const [statusMsg, setStatusMsg] = useState(apiKey ? 'スキャンするか手入力してください' : 'カメラ機能でスキャンする場合には、APIキーが必要です');
            const [showSettings, setShowSettings] = useState(false);

            const videoRef = useRef(null);
            const streamRef = useRef(null);

            const saveApiKey = () => {
                const trimmed = apiKey.trim();
                localStorage.setItem('gemini_sudoku_key', trimmed);
                setApiKey(trimmed);
                setShowSettings(false);
                setStatusMsg('APIキーを保存しました');
            };

            const isValid = (board, r, c, n) => {
                for (let i = 0; i < 9; i++) {
                    if (board[r][i] === n && i !== c) return false;
                    if (board[i][c] === n && i !== r) return false;
                }
                const sR = Math.floor(r / 3) * 3, sC = Math.floor(c / 3) * 3;
                for (let i = 0; i < 3; i++)
                    for (let j = 0; j < 3; j++)
                        if (board[sR + i][sC + j] === n && (sR + i !== r || sC + j !== c)) return false;
                return true;
            };

            const solve = () => {
                setIsSolving(true);
                setStatusMsg('解析中...');
                setTimeout(() => {
                    const board = JSON.parse(JSON.stringify(grid));
                    const solver = (b) => {
                        for (let r = 0; r < 9; r++) {
                            for (let c = 0; c < 9; c++) {
                                if (b[r][c] === 0) {
                                    for (let n = 1; n <= 9; n++) {
                                        if (isValid(b, r, c, n)) {
                                            b[r][c] = n;
                                            if (solver(b)) return true;
                                            b[r][c] = 0;
                                        }
                                    }
                                    return false;
                                }
                            }
                        }
                        return true;
                    };
                    if (solver(board)) {
                        setSolvedGrid(board);
                        setStatusMsg('解析完了！');
                    } else {
                        setStatusMsg('解が見つかりませんでした');
                    }
                    setIsSolving(false);
                }, 100);
            };

            const openCamera = async () => {
                if (!apiKey) { setShowSettings(true); return; }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } 
                    });
                    streamRef.current = stream;
                    setIsCameraActive(true);
                    setTimeout(() => { if (videoRef.current) videoRef.current.srcObject = stream; }, 300);
                } catch (e) {
                    setStatusMsg('カメラ起動失敗。HTTPSかブラウザの設定を確認してください。');
                }
            };

            const closeCamera = () => {
                if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
                setIsCameraActive(false);
            };

            const capture = async () => {
                if (!videoRef.current || !apiKey) return;
                setIsScanning(true);
                setStatusMsg('画像を解析中...');

                try {
                    const canvas = document.createElement('canvas');
                    // 元のビデオ解像度を維持してキャプチャ
                    canvas.width = videoRef.current.videoWidth;
                    canvas.height = videoRef.current.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(videoRef.current, 0, 0);
                    
                    const base64 = canvas.toDataURL('image/png').split(',')[1];
                    closeCamera();

                    // Gemini APIリクエスト（命令をより具体的に修正）
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [
                                { text: "This is an image of a Sudoku puzzle. Please analyze the grid and return only a JSON object containing a 9x9 array of numbers. Use 0 for empty cells. Format: {\"grid\": [[row1], [row2], ...]}." },
                                { inlineData: { mimeType: "image/png", data: base64 } }
                            ]}],
                            generationConfig: {
                                responseMimeType: "application/json"
                            }
                        })
                    });

                    if (!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.error?.message || 'APIリクエスト失敗');
                    }

                    const data = await res.json();
                    let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    // JSON部分を抽出（たまにmarkdownのバッククォートが含まれるため）
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const json = JSON.parse(jsonMatch[0]);
                        if (json.grid && Array.isArray(json.grid) && json.grid.length === 9) {
                            setGrid(json.grid);
                            setSolvedGrid(null);
                            setStatusMsg('スキャン成功！必要に応じて修正してください。');
                        } else {
                            throw new Error('不適切なグリッド形式');
                        }
                    } else {
                        throw new Error('解析データが見つかりません');
                    }
                } catch (e) {
                    console.error(e);
                    setStatusMsg(`取り込み失敗: ${e.message}`);
                } finally { 
                    setIsScanning(false); 
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center p-4">
                    <header className="w-full max-w-sm flex justify-between items-center py-6">
                        <h1 className="text-xl font-black italic tracking-tighter">SUDOKU <span className="text-indigo-600">AI</span></h1>
                        <button onClick={() => setShowSettings(true)} className="p-2 bg-white rounded-xl shadow-sm border border-slate-200">
                            <Icon name="settings" size={20} className="text-slate-500" />
                        </button>
                    </header>

                    {/* Grid */}
                    <div className="bg-slate-900 p-1 rounded-xl shadow-2xl mb-6 relative">
                        {isScanning && (
                            <div className="absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center gap-3 rounded-lg border-4 border-indigo-500">
                                <Icon name="loader-2" size={40} className="animate-spin text-indigo-600" />
                                <p className="font-black text-indigo-600 tracking-widest text-xs uppercase animate-pulse">Scanning Grid...</p>
                            </div>
                        )}
                        <div className="grid grid-cols-9 bg-slate-900 border-2 border-slate-900">
                            {(solvedGrid || grid).map((row, r) => row.map((cell, c) => (
                                <div 
                                    key={`${r}-${c}`}
                                    onClick={() => {setSelectedCell({r,c}); setSolvedGrid(null);}}
                                    className={`w-9 h-9 sm:w-12 sm:h-12 flex items-center justify-center text-lg font-bold cursor-pointer transition-colors
                                        ${selectedCell?.r === r && selectedCell?.c === c ? 'bg-indigo-600 text-white' : 'bg-white'}
                                        ${(c+1)%3 === 0 && c!==8 ? 'border-r-4' : 'border-r'}
                                        ${(r+1)%3 === 0 && r!==8 ? 'border-b-4' : 'border-b'}
                                        ${!grid[r][c] && solvedGrid ? 'text-indigo-600 bg-indigo-50' : 'text-slate-800'}
                                    `}
                                >
                                    {cell !== 0 ? cell : ''}
                                </div>
                            )))}
                        </div>
                    </div>

                    {/* Info */}
                    <div className="w-full max-w-sm bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-4 flex items-start gap-3">
                        <Icon name="info" size={18} className="text-indigo-500 mt-0.5 shrink-0" />
                        <div className="flex-1 overflow-hidden">
                            <p className="text-[12px] font-bold text-slate-700 break-words">{statusMsg}</p>
                            <p className="text-[10px] text-slate-400 font-medium">{!apiKey ? '※右上の設定ボタンからAPIキーを設定してください' : '※マスをタップして手動で数字を修正できます'}</p>
                        </div>
                    </div>

                    {/* Controls */}
                    <div className="w-full max-w-sm space-y-4">
                        <div className="grid grid-cols-5 gap-2">
                            {[1,2,3,4,5,6,7,8,9,0].map(n => (
                                <button key={n} onClick={() => {
                                    if(!selectedCell) return;
                                    const next = [...grid]; next[selectedCell.r][selectedCell.c] = n;
                                    setGrid(next);
                                }} className="h-12 bg-white rounded-xl font-black shadow-sm border border-slate-200 active:scale-90 active:bg-indigo-50 transition-all">
                                    {n === 0 ? <Icon name="trash-2" size={18} className="mx-auto text-slate-300"/> : n}
                                </button>
                            ))}
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={openCamera} className="flex items-center justify-center gap-2 py-4 bg-white border-2 border-slate-200 rounded-2xl font-black text-sm active:scale-95 transition-all">
                                <Icon name="camera" /> SCAN
                            </button>
                            <button onClick={solve} disabled={isSolving} className="flex items-center justify-center gap-2 py-4 bg-slate-900 text-white rounded-2xl font-black text-sm active:scale-95 disabled:opacity-50 transition-all">
                                {isSolving ? '...' : <><Icon name="play" size={16}/> SOLVE</>}
                            </button>
                        </div>
                        <button onClick={() => {setGrid(Array.from({length:9},()=>Array(9).fill(0))); setSolvedGrid(null);}} className="w-full text-[10px] font-bold text-slate-400 uppercase tracking-widest hover:text-red-400">Clear Board</button>
                    </div>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-slate-900/90 z-[100] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-xs p-8 rounded-[2rem] shadow-2xl text-center animate-in zoom-in duration-200">
                                <Icon name="key" size={40} className="mx-auto text-indigo-500 mb-4" />
                                <h2 className="font-black text-lg mb-2">Gemini API Key</h2>
                                <p className="text-[11px] text-slate-500 mb-6">Google AI Studioで取得したAPIキーを入力してください。キーは安全にブラウザのみに保存されます。</p>
                                <input 
                                    type="password" 
                                    className="w-full p-4 bg-slate-100 rounded-2xl mb-6 text-sm font-mono border-2 border-transparent focus:border-indigo-500 outline-none transition-all"
                                    placeholder="AIZA..."
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                />
                                <button onClick={saveApiKey} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg shadow-indigo-200 active:scale-95 transition-all">SAVE KEY</button>
                            </div>
                        </div>
                    )}

                    {/* Camera Overlay with Guides */}
                    {isCameraActive && (
                        <div className="fixed inset-0 bg-black z-[200] flex flex-col overflow-hidden">
                            <video ref={videoRef} className="flex-1 object-cover" autoPlay playsInline muted />
                            
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <div className="relative w-72 h-72">
                                    <div className="absolute top-0 left-0 w-10 h-10 border-t-4 border-l-4 border-indigo-500 rounded-tl-xl shadow-[0_0_15px_#6366f1]"></div>
                                    <div className="absolute top-0 right-0 w-10 h-10 border-t-4 border-r-4 border-indigo-500 rounded-tr-xl shadow-[0_0_15px_#6366f1]"></div>
                                    <div className="absolute bottom-0 left-0 w-10 h-10 border-b-4 border-l-4 border-indigo-500 rounded-bl-xl shadow-[0_0_15px_#6366f1]"></div>
                                    <div className="absolute bottom-0 right-0 w-10 h-10 border-b-4 border-r-4 border-indigo-500 rounded-br-xl shadow-[0_0_15px_#6366f1]"></div>
                                    
                                    <div className="absolute inset-0 grid grid-cols-3">
                                        <div className="border-r border-indigo-500/20"></div>
                                        <div className="border-r border-indigo-500/20"></div>
                                        <div></div>
                                    </div>
                                    <div className="absolute inset-0 grid grid-rows-3">
                                        <div className="border-b border-indigo-500/20"></div>
                                        <div className="border-b border-indigo-500/20"></div>
                                        <div></div>
                                    </div>

                                    <div className="scanner-line absolute top-0 left-0 w-full"></div>
                                </div>

                                <div className="absolute inset-0 shadow-[0_0_0_1000px_rgba(0,0,0,0.7)] pointer-events-none"></div>
                                
                                <div className="absolute top-16 text-white text-[10px] font-black bg-indigo-600/90 px-5 py-2 rounded-full tracking-widest uppercase shadow-xl">
                                    Align puzzle inside corners
                                </div>
                            </div>

                            <div className="absolute bottom-0 left-0 w-full h-40 bg-slate-950 flex items-center justify-around px-8 z-[300]">
                                <button onClick={closeCamera} className="text-white/40 font-black text-[10px] uppercase tracking-widest active:text-white flex flex-col items-center gap-2">
                                    <Icon name="x-circle" size={24} />
                                    <span>Cancel</span>
                                </button>
                                <button onClick={capture} className="w-24 h-24 bg-white rounded-full border-[8px] border-slate-800 flex items-center justify-center shadow-2xl active:scale-90 transition-all">
                                    <div className="w-16 h-16 rounded-full border-2 border-slate-200"></div>
                                </button>
                                <div className="w-16"></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>