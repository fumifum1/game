<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬26å› ä¸™åˆæ¯ãƒ€ãƒ¼ãƒ“ãƒ¼</title>
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/fumifum1/main/main/jpg/ico.ico">
    <style>
        :root {
            --primary: #3e2723;
            --bg-paper: #f4e7d3;
            --accent: #8b0000;
            --track-light: #8d6e63;
            --track-dark: #5d4037;
            --success: #2e7d32;
            --gold: #ffd700;
            --info: #0277bd;
            --btn-border: #3e2723;
        }

        body {
            font-family: "serif", "YuMincho", "Yu Mincho", "MS Mincho", serif;
            background-color: var(--bg-paper);
            color: var(--primary);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            border: 4px solid var(--primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* --- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .hamburger {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 25px;
            cursor: pointer;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hamburger span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: var(--primary);
            transition: all 0.3s;
        }

        .hamburger.open span:nth-child(1) {
            transform: translateY(11px) rotate(45deg);
        }

        .hamburger.open span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.open span:nth-child(3) {
            transform: translateY(-11px) rotate(-45deg);
        }

        #menu-content {
            position: fixed;
            top: 0;
            right: -250px;
            width: 200px;
            height: 100%;
            background-color: var(--bg-paper);
            border-left: 3px solid var(--primary);
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
            z-index: 1999;
            transition: right 0.3s;
            padding-top: 60px;
        }

        #menu-content.open {
            right: 0;
        }

        #menu-content ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #menu-content li {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(62, 39, 35, 0.1);
        }

        #menu-content a {
            text-decoration: none;
            color: var(--primary);
            font-weight: bold;
            display: block;
        }

        footer {
            background-color: var(--primary);
            color: var(--bg-paper);
            text-align: center;
            padding: 15px 10px;
            font-size: 0.7rem;
            margin-top: auto;
        }

        footer a {
            color: var(--gold);
            text-decoration: none;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px 10px;
            text-align: center;
            flex: 1;
        }

        .main-image {
            width: 100%;
            max-width: 320px;
            height: auto;
            margin: 0 auto 10px auto;
            display: block;
        }

        .image-fallback {
            font-weight: bold;
            font-size: 1.2rem;
            margin: 20px 0;
            color: var(--primary);
        }

        .btn {
            display: inline-block;
            cursor: pointer;
            font-weight: 900;
            border: 2px solid var(--primary);
            padding: 8px 16px;
            margin: 5px;
            background: white;
            font-size: 0.9rem;
            user-select: none;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--success);
            color: white;
            padding: 12px 30px;
            font-size: 1rem;
            box-shadow: 3px 3px 0px #1b5e20;
        }

        .btn-primary:active {
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: #fff;
            width: 100%;
            max-width: 400px;
            padding: 20px;
            border: 2px solid #333;
            text-align: center;
            box-shadow: 10px 10px 0px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .guide-text {
            text-align: left;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .guide-text h3 {
            border-left: 4px solid var(--accent);
            padding-left: 8px;
            margin: 15px 0 5px;
            font-size: 1rem;
        }

        .setup-card {
            background: white;
            border: 2px solid var(--primary);
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 900;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 10px;
            padding-bottom: 3px;
            display: block;
        }

        .name-input-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 5px;
            background: #fafafa;
        }

        .name-input-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            gap: 5px;
        }

        .name-input-item span {
            width: 25px;
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            background: var(--primary);
            color: white;
            border-radius: 2px;
        }

        .name-input-item input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            font-size: 0.85rem;
        }

        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 8px;
            margin: 10px 0;
            justify-content: center;
        }

        .prediction-num {
            border: 2px solid var(--primary);
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
            font-weight: 900;
            font-size: 1.1rem;
            transition: all 0.2s;
        }

        .prediction-num.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .fanfare-screen {
            background-color: var(--primary);
            background-image: linear-gradient(rgba(62, 39, 35, 0.8), rgba(62, 39, 35, 0.8)), url('images/uma.png');
            background-size: 70%;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .fanfare-timer {
            font-size: 6rem;
            font-weight: 900;
            margin: 10px 0;
            color: var(--gold);
            text-shadow: 4px 4px 10px rgba(0, 0, 0, 0.8);
            z-index: 10;
        }

        .race-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .race-header {
            background: var(--primary);
            color: var(--bg-paper);
            padding: 5px 0;
            text-align: center;
            z-index: 100;
            border-bottom: 2px solid #000;
        }

        .my-ticket-badge {
            background: #fff;
            color: var(--primary);
            padding: 2px 12px;
            display: inline-block;
            margin-top: 2px;
            font-size: 0.85rem;
            font-weight: 900;
            border: 1px solid #000;
            border-radius: 20px;
        }

        .track-area {
            flex: 1;
            background-color: var(--track-dark);
            overflow-y: auto;
            position: relative;
        }

        .lane {
            position: relative;
            height: 35px;
            background: var(--track-light);
            border-bottom: 1px solid var(--track-dark);
            display: flex;
            align-items: center;
        }

        .lane-sidebar {
            width: 30px;
            height: 100%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .lane-bg-name {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -55%);
            font-size: 16px;
            font-weight: 900;
            color: #ffffff;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
            text-shadow: 2px 2px 0 var(--primary), -1px -1px 0 var(--primary), 1px -1px 0 var(--primary), -1px 1px 0 var(--primary), 1px 1px 0 var(--primary);
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 10px;
            border-radius: 10px;
        }

        .horse-sprite {
            position: absolute;
            z-index: 50;
            transition: left 0.1s linear;
            display: flex;
            align-items: center;
        }

        .horse-emoji {
            font-size: 24px;
            transform: scaleX(-1);
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
        }

        .goal-line {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            border-left: 2px dashed white;
            background: rgba(255, 255, 255, 0.05);
            z-index: 20;
        }

        @keyframes stamp {
            0% {
                transform: scale(3);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .reveal-item {
            animation: stamp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .lottery-box {
            background: #e0e0e0;
            border: 4px solid var(--primary);
            padding: 20px;
            font-size: 1.5rem;
            font-weight: 900;
            margin: 20px 0;
            transition: background 0.3s;
        }

        .lottery-box.active {
            background: #fffde7;
        }

        .guest-notice {
            background: #fff3e0;
            border: 2px solid #ff9800;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.85rem;
            color: #e65100;
            font-weight: bold;
            line-height: 1.4;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="hamburger" id="hamburger-icon" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <nav id="menu-content">
        <ul>
            <li><a href="../main/index.html">Profile</a></li>
            <li><a href="https://fumifum1.github.io/main/game.html">Game</a></li>
            <li style="border-top: 1px solid var(--btn-border); margin: 4px 0; padding: 0;"></li>
            <li><a href="https://fumifum1.github.io/game/derby_h6.html">å† ä¸»ã€Šãƒ›ã‚¹ãƒˆã€‹ãƒ¬ãƒ¼ã‚¹</a></li>
            <li><a href="#" onclick="toggleHelp(); return false;">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</a></li>
        </ul>
    </nav>

    <div id="app"></div>

    <div id="guide-modal" class="modal-overlay" onclick="closeGuide()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 style="border-bottom: 2px solid var(--primary); padding-bottom: 10px;">éŠã³æ–¹ã‚¬ã‚¤ãƒ‰</h2>
            <div class="guide-text">
                <h3>1. é–‹å‚¬æº–å‚™ï¼ˆãƒ›ã‚¹ãƒˆï¼‰</h3>
                <p>ã€Œå† ä¸»ã¨ã—ã¦é–‹å‚¬ã€ã‚’æŠ¼ã—ã€å‡ºèµ°é ­æ•°ã‚’æ±ºã‚ã¾ã™ã€‚å„é¦¬ã«åå‰ã‚’ä»˜ã‘ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</p>
                <h3>2. å‚åŠ è€…ã®æ‹›å¾…</h3>
                <p>ç”»é¢ä¸‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’å‚åŠ è€…ã«èª­ã¿å–ã£ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚å…¨å“¡ãŒåŒã˜è¨­å®šï¼ˆå‡ºèµ°æ•°ãƒ»å‹é¦¬ãƒ»é…å½“ï¼‰ã§å‚åŠ ã§ãã¾ã™ã€‚â€»å‚åŠ è€…ã®ç”»é¢ã§ã¯é¦¬ã®åå‰ã¯ã€Œå‚åŠ è€…1ã€2...ã€ã¨å›ºå®šã•ã‚Œã¾ã™ã€‚</p>
                <h3>3. äºˆæƒ³é¦¬åˆ¸ã®è³¼å…¥</h3>
                <p>è‡ªåˆ†ã®å‹ã¡é¦¬ã‚’1é ­é¸ã³ã€ç•ªå·ã‚’æŠ¼ã™ã¨é¦¬åˆ¸ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚å…¨å“¡ãŒæº–å‚™ã§ããŸã‚‰æ›ã‘å£°ã¨åŒæ™‚ã«ã€Œå‡ºèµ°é–‹å§‹ã€ï¼</p>
                <h3>4. é…å½“ã®æŠ½é¸</h3>
                <p>ãƒ¬ãƒ¼ã‚¹çµ‚äº†å¾Œã€ä¸Šä½3é ­ã¸ã®ã€Œé…å½“ãƒ«ãƒ¼ãƒ«ã€ã‚’æŠ½é¸ã—ã¾ã™ã€‚1ä½ç·å–ã‚Šã‹ã€å‡ç­‰åˆ†é…ã‹â€¦é‹å‘½ãŒæ±ºã¾ã‚Šã¾ã™ã€‚</p>
            </div>
            <div onclick="closeGuide()" class="btn btn-primary" style="margin-top: 20px; width: 80%;">é–‰ã˜ã‚‹</div>
        </div>
    </div>

    <div id="ticket-modal" class="modal-overlay" onclick="closeModalForce()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div
                style="border-bottom: 2px solid #333; display: flex; justify-content: space-between; font-weight: bold; font-size: 0.7rem; padding-bottom: 5px; margin-bottom: 15px;">
                <span>ç¬¬26å› ä¸™åˆæ¯ãƒ€ãƒ¼ãƒ“ãƒ¼</span>
                <span>å˜å‹</span>
            </div>
            <div id="ticket-num" style="font-size: 3.5rem; font-weight: 900; line-height: 1;">00</div>
            <div id="ticket-name" style="font-size: 1.5rem; font-weight: 900; margin: 15px 0;">---</div>
            <div onclick="startPreRaceSequence()" class="btn btn-primary" style="width: 80%; margin: 0 auto;">å‡ºèµ°é–‹å§‹</div>
        </div>
    </div>

    <footer>
        &copy; 2026 Synapse Creations. derby race game_ver6.5.2 <a
            href="https://fumifum1.github.io/main/index.html">Creator/fumifumi</a>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        function toggleMenu() {
            const menu = document.getElementById('menu-content');
            const icon = document.getElementById('hamburger-icon');
            menu.classList.toggle('open');
            icon.classList.toggle('open');
        }
        function toggleHelp() { toggleMenu(); openGuide(); }

        const sounds = {
            fanfare: new Audio('sounds/1.mp3'),
            gateOpen: new Audio('sounds/2.mp3'),
            running: new Audio('sounds/3.mp3'),
            applause: new Audio('sounds/sound4.mp3'),
            drumroll: new Audio('sounds/5.mp3'),
            finish: new Audio('sounds/6.mp3')
        };
        sounds.running.loop = true;

        function playSound(key) { try { sounds[key].currentTime = 0; sounds[key].play().catch(() => { }); } catch (e) { } }
        function stopSound(key) { try { sounds[key].pause(); sounds[key].currentTime = 0; } catch (e) { } }

        const LEGEND_HORSES = ["ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ", "ã‚ªã‚°ãƒªã‚­ãƒ£ãƒƒãƒ—", "ãƒˆã‚¦ã‚«ã‚¤ãƒ†ã‚¤ã‚ªãƒ¼", "ã‚µã‚¤ãƒ¬ãƒ³ã‚¹ã‚¹ã‚ºã‚«", "ãƒŠãƒªã‚¿ãƒ–ãƒ©ã‚¤ã‚¢ãƒ³", "ã‚¨ãƒ«ã‚³ãƒ³ãƒ‰ãƒ«ãƒ‘ã‚µãƒ¼", "ã‚·ãƒ³ãƒœãƒªãƒ«ãƒ‰ãƒ«ãƒ•", "ã‚¦ã‚©ãƒƒã‚«", "ãƒ€ã‚¤ãƒ¯ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆ", "ã‚´ãƒ¼ãƒ«ãƒ‰ã‚·ãƒƒãƒ—", "ã‚­ã‚¿ã‚µãƒ³ãƒ–ãƒ©ãƒƒã‚¯", "ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰ã‚¢ã‚¤", "ã‚³ãƒ³ãƒˆãƒ¬ã‚¤ãƒ«", "ã‚¤ã‚¯ã‚¤ãƒãƒƒã‚¯ã‚¹"];
        const HORSE_PREFIXES = ["ã‚µã‚¯ãƒ©", "ãƒ¡ã‚¸ãƒ­", "ãƒˆã‚¦ã‚«ã‚¤", "ã‚·ãƒ³ãƒœãƒª", "ãƒ€ã‚¤ãƒ¯", "ãƒãƒã‚«ãƒ", "ã‚¢ã‚°ãƒã‚¹", "ãƒãƒ³ãƒãƒƒã‚¿ãƒ³", "ã‚¢ãƒ‰ãƒã‚¤ãƒ¤", "ã‚¹ãƒãƒ¼ãƒˆ", "ã‚´ãƒ¼ãƒ«ãƒ‰", "ã‚­ãƒ³ã‚°", "ãƒŠãƒªã‚¿"];
        const HORSE_SUFFIXES = ["ãƒã‚¯ã‚·ãƒ³ã‚ªãƒ¼", "ãƒãƒƒã‚¯ã‚¤ãƒ¼ãƒ³", "ãƒ†ã‚¤ã‚ªãƒ¼", "ã‚ªãƒ¼ã‚·ãƒ£ãƒ³", "ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆ", "ãƒ•ã‚¯ã‚­ã‚¿ãƒ«", "ã‚¿ã‚­ã‚ªãƒ³", "ã‚«ãƒ•ã‚§", "ãƒ™ã‚¬", "ãƒ•ã‚¡ãƒ«ã‚³ãƒ³", "ã‚·ãƒƒãƒ—", "ã‚«ãƒ¡ãƒãƒ¡ãƒ", "ã‚¿ã‚¤ã‚·ãƒ³"];

        function generateHorseName(index) {
            if (index < LEGEND_HORSES.length && Math.random() > 0.3) return LEGEND_HORSES[index];
            const pre = HORSE_PREFIXES[Math.floor(Math.random() * HORSE_PREFIXES.length)];
            const suf = HORSE_SUFFIXES[Math.floor(Math.random() * HORSE_SUFFIXES.length)];
            return pre + suf;
        }

        const PAYOUT_SCENARIOS = [
            { id: 0, name: "ä¸€æ”«åƒé‡‘", ratios: [1.0, 0, 0], desc: "1ä½ãŒå…¨ã¦ã®æ ã‚’ç‹¬å " },
            { id: 1, name: "å¾¡ä¸‰å®¶ãƒ»ç­‰åˆ†", ratios: [0.34, 0.33, 0.33], desc: "ä¸Šä½3åã§å‡ç­‰ã«åˆ†é…" },
            { id: 2, name: "ç¾å®Ÿå‹", ratios: [0.6, 0.25, 0.15], desc: "ä¼çµ±çš„ãªå‚¾æ–œé…åˆ†" },
            { id: 3, name: "å®ŸåŠ›ä¸»ç¾©", ratios: [0.7, 0.2, 0.1], desc: "å®ŸåŠ›å‚¾æ–œé…åˆ†" },
            { id: 4, name: "åœ§å€’å®ŸåŠ›", ratios: [0.8, 0.15, 0.05], desc: "åœ§å€’çš„ãªå‚¾æ–œé…åˆ†" },
            { id: 5, name: "ä¸‹å‰‹ä¸Š", ratios: [0.1, 0.5, 0.4], desc: "2ä½ãƒ»3ä½ã«æ‰‹åšã„ï¼" },
            { id: 6, name: "è¶…ä¸‹å‰‹ä¸Š", ratios: [0.1, 0.2, 0.7], desc: "3ä½ä¸‡é¦¬åˆ¸ï¼" },
            { id: 7, name: "æ··æ²Œï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰", ratios: null, desc: "é…åˆ†ã¯ç¥ã®ã¿çŸ¥ã‚‹" }
        ];

        class SeededRandom {
            constructor(seed) { this.seed = seed; }
            next() { this.seed = (this.seed * 9301 + 49297) % 233280; return this.seed / 233280; }
        }

        let state = {
            gameState: 'mode_select',
            isHost: false,
            seed: Math.floor(Math.random() * 1000000),
            playerCount: 15,
            payoutScenarioIdx: Math.floor(Math.random() * PAYOUT_SCENARIOS.length),
            myPrediction: null,
            horses: [],
            winners: [],
            finishOrder: [], // å®Ÿéš›ã«ã‚´ãƒ¼ãƒ«ã—ãŸé †åº
            allFinishedRanks: [],
            payoutMode: null,
            horseNames: [],
            isLotterySpinning: false,
            payoutScenarioIdx: Math.floor(Math.random() * PAYOUT_SCENARIOS.length),
            myPrediction: null,
            horses: [],
            winners: [],
            finishOrder: [], // å®Ÿéš›ã«ã‚´ãƒ¼ãƒ«ã—ãŸé †åº
            allFinishedRanks: [],
            payoutMode: null,
            horseNames: [],
            isLotterySpinning: false,
            countdown: 7,
            payoutScenarioIdx: Math.floor(Math.random() * PAYOUT_SCENARIOS.length),
            myPrediction: null,
            horses: [],
            winners: [],
            finishOrder: [], // å®Ÿéš›ã«ã‚´ãƒ¼ãƒ«ã—ãŸé †åº
            allFinishedRanks: [],
            payoutMode: null,
            horseNames: [],
            isLotterySpinning: false,
            countdown: 7,
            hostMode: 'random', // 'random' or 'master'
            riggedWinnerId: -1, // -1 means random, otherwise horse ID
            customRatios: null // [r1, r2, r3] percentages
        };

        function initHorseNames(count, asHost) {
            const newNames = [];
            for (let i = 0; i < count; i++) {
                if (asHost) {
                    const existing = state.horseNames[i];
                    if (!existing || existing.startsWith('å‚åŠ è€…')) {
                        newNames.push(generateHorseName(i));
                    } else {
                        newNames.push(existing);
                    }
                } else {
                    newNames.push(`å‚åŠ è€…${i + 1}`);
                }
            }
            state.horseNames = newNames;
        }

        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            app.innerHTML = '';
            const container = document.createElement('div');
            container.className = "container";

            if (state.gameState === 'mode_select') {
                container.innerHTML = `
                    <h1 style="font-weight:900; font-size:1.5rem; margin:30px 0 10px 0;">ç¬¬26å› ä¸™åˆæ¯ãƒ€ãƒ¼ãƒ“ãƒ¼</h1>
                    <div id="main-image-container">
                        <img src="images/uma.png" alt="ç«¶é¦¬ãƒ­ã‚´" class="main-image" onerror="showFallbackText(this)">
                    </div>
                    <p style="margin: 10px 0 30px 0; font-weight: bold;">ä¼çµ±ã¨æ „å…‰ã®ãƒ¬ãƒ¼ã‚¹ãŒä»Šã€å§‹ã¾ã‚‹ã€‚</p>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                        <div onclick="showModeSelectModal()" class="btn btn-primary">å† ä¸»ã¨ã—ã¦é–‹å‚¬</div>
                        <div onclick="openGuide()" class="btn btn-outline" style="font-size: 0.8rem; border-color: #ccc;">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</div>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 20px;">â€»éŸ³éŸ¿åŠ¹æœãŒé³´ã‚Šã¾ã™ã€‚ã”æ³¨æ„ãã ã•ã„ã€‚</p>
                    </div>
                `;
            }
            else if (state.gameState === 'host_setup') {
                const headerText = state.isHost ? (state.hostMode === 'master' ? "é–‹å‚¬æº–å‚™ï¼ˆæ”¯é…äººãƒ¢ãƒ¼ãƒ‰ï¼‰" : "é–‹å‚¬æº–å‚™") : "æº–å‚™å®Œäº†ï¼ˆã‚²ã‚¹ãƒˆå‚åŠ ä¸­ï¼‰";
                const predictionSection = (state.isHost && state.hostMode === 'master') ? `
                    <div class="setup-card">
                        <span class="section-title">ãƒ¬ãƒ¼ã‚¹çµæœã®æ“ä½œï¼ˆæ”¯é…äººæ¨©é™ï¼‰</span>
                        <div style="margin-bottom:10px;">
                            <div style="font-size:0.8rem; font-weight:bold;">å‹åˆ©ã•ã›ã‚‹é¦¬</div>
                            <select onchange="updateRiggedWinner(this.value)" style="width:100%; padding:8px;">
                                <option value="-1">ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆæ“ä½œãªã—ï¼‰</option>
                                ${state.horseNames.map((n, i) => `<option value="${i}" ${state.riggedWinnerId == i ? 'selected' : ''}>${i + 1}: ${n}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div style="font-size:0.8rem; font-weight:bold;">é…å½“ãƒ‘ã‚¿ãƒ¼ãƒ³</div>
                            <select id="payout-select" onchange="updateRiggedPayout(this.value)" style="width:100%; padding:8px;">
                                ${PAYOUT_SCENARIOS.map((s, i) => `<option value="${i}" ${state.payoutScenarioIdx == i ? 'selected' : ''}>${s.name}</option>`).join('')}
                            </select>
                            
                            <div style="margin-top:10px; background:#f5f5f5; padding:8px; border:1px solid #ddd; border-radius:4px;">
                                <div style="font-size:0.75rem; font-weight:bold; margin-bottom:5px;">é…å½“å‰²åˆã®èª¿æ•´ï¼ˆåˆè¨ˆ100%ã«ãªã‚‹ã‚ˆã†ã«è¨­å®šï¼‰</div>
                                <div style="display:flex; gap:5px; align-items:center;">
                                    <div style="flex:1;"><span style="font-size:0.7rem;">1ç€</span><input type="number" id="ratio-0" value="${(state.customRatios || getScenarioRatios(state.payoutScenarioIdx))[0]}" onchange="updateCustomRatio(0, this.value)" style="width:100%; padding:4px;"></div>
                                    <div style="flex:1;"><span style="font-size:0.7rem;">2ç€</span><input type="number" id="ratio-1" value="${(state.customRatios || getScenarioRatios(state.payoutScenarioIdx))[1]}" onchange="updateCustomRatio(1, this.value)" style="width:100%; padding:4px;"></div>
                                    <div style="flex:1;"><span style="font-size:0.7rem;">3ç€</span><input type="number" id="ratio-2" value="${(state.customRatios || getScenarioRatios(state.payoutScenarioIdx))[2]}" onchange="updateCustomRatio(2, this.value)" style="width:100%; padding:4px;"></div>
                                </div>
                                <div id="ratio-error" style="color:red; font-size:0.7rem; font-weight:bold; margin-top:5px; display:none;">åˆè¨ˆãŒ100%ã«ãªã£ã¦ã„ã¾ã›ã‚“ï¼</div>
                            </div>
                        </div>
                        <div id="start-btn-host" onclick="startPreRaceSequence()" class="btn btn-primary" style="margin-top:15px; width:90%;">å‡ºèµ°é–‹å§‹ï¼ˆæ”¯é…äººï¼‰</div>
                    </div>
                ` : `
                    <div class="setup-card">
                        <span class="section-title">é¦¬åˆ¸ã®è³¼å…¥ï¼ˆäºˆæƒ³é¦¬åˆ¸ã®é¸æŠï¼‰</span>
                        <div class="prediction-grid">
                            ${state.horseNames.map((_, i) => `
                                <div onclick="selectPrediction(${i})" class="prediction-num ${state.myPrediction === i ? 'selected' : ''}">
                                    ${i + 1}
                                </div>
                            `).join('')}
                        </div>
                        <p style="font-size:0.8rem; color:#666; text-align:center; margin-top:10px;">å‹ã¡é¦¬ã®ç•ªå·ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
                    </div>
                `;

                container.innerHTML = `
                    <h2 style="font-size:1.2rem; margin-bottom:15px;">${headerText}</h2>
                    ${state.isHost ? `
                    <div class="setup-card">
                        <span class="section-title">1. å‡ºèµ°é ­æ•°è¨­å®š</span>
                        <select onchange="handleCountChange(this.value)" style="width:100%; padding:8px;">
                            ${Array.from({ length: 26 }, (_, i) => i + 5).map(n => `<option value="${n}" ${n == state.playerCount ? 'selected' : ''}>${n}é ­ç«‹ã¦</option>`).join('')}
                        </select>
                    </div>
                    <div class="setup-card">
                        <span class="section-title">2. å‡ºèµ°é¦¬åç°¿</span>
                        <div class="name-input-list">
                            ${state.horseNames.map((name, i) => `
                                <div class="name-input-item">
                                    <span>${i + 1}</span>
                                    <input type="text" value="${name}" onchange="updateHorseName(${i}, this.value)">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="setup-card">
                        <span class="section-title">ãƒ¬ãƒ¼ã‚¹è¨­å®š</span>
                        <p style="font-size:0.9rem; margin:0;">${state.playerCount}é ­ç«‹ã¦ã®ãƒ¬ãƒ¼ã‚¹ã«å‚åŠ ã—ã¾ã—ãŸã€‚</p>
                    </div>
                    `}
                    ${predictionSection}
                    ${state.isHost ? `
                    <div class="setup-card" style="text-align:center;">
                        <span class="section-title">æ‹›å¾…QRï¼ˆã‚¹ã‚­ãƒ£ãƒ³ã—ã¦å‚åŠ ï¼‰</span>
                        <div id="qrcode" style="display:inline-block; border:2px solid #000; padding:10px; background:#fff;"></div>
                    </div>
                    ` : ''}
                `;
                if (state.isHost) setTimeout(() => updateHostQR(), 0);
            }
            else if (state.gameState === 'pre_race') { renderPreRace(app); return; }
            else if (state.gameState === 'racing') { renderRacing(app); return; }
            else if (state.gameState === 'reveal_ranks') { renderRankReveal(container); }
            else if (state.gameState === 'lottery') { renderLottery(container); }
            else if (state.gameState === 'finished') { renderFinished(container); }

            app.appendChild(container);
        }

        function showFallbackText(img) {
            img.parentElement.innerHTML = '<div class="image-fallback">ç«¶é¦¬ãƒ­ã‚´</div>';
        }

        function openGuide() { document.getElementById('guide-modal').style.display = 'flex'; }
        function closeGuide() { document.getElementById('guide-modal').style.display = 'none'; }

        function showModeSelectModal() {
            const container = document.getElementById('app').querySelector('.container');
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 style="margin-bottom:15px;">é–‹å‚¬ãƒ¢ãƒ¼ãƒ‰ã®é¸æŠ</h2>
                    <div onclick="initHost('random')" class="btn btn-primary" style="width:80%;">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰<br><span style="font-size:0.7rem; font-weight:normal;">ãƒ©ãƒ³ãƒ€ãƒ å¯¾æˆ¦ãƒ»ãƒ›ã‚¹ãƒˆã‚‚å‚åŠ </span></div>
                    <div onclick="initHost('master')" class="btn btn-primary" style="width:80%; background-color:#5d4037;">æ”¯é…äººãƒ¢ãƒ¼ãƒ‰<br><span style="font-size:0.7rem; font-weight:normal;">çµæœã‚’æ“ä½œãƒ»ãƒ›ã‚¹ãƒˆã¯è¦³æˆ¦ã®ã¿</span></div>
                    <div onclick="this.parentElement.parentElement.remove()" class="btn btn-outline" style="margin-top:15px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function initHost(mode = 'random') {
            state.isHost = true;
            state.hostMode = mode;
            state.gameState = 'host_setup';
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°æ¶ˆã™
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(m => { if (!m.id) m.remove(); });

            initHorseNames(state.playerCount, true);
            render();
        }

        function updateRiggedWinner(val) {
            state.riggedWinnerId = Number(val);
            updateHostQR();
        }

        function updateRiggedPayout(val) {
            state.payoutScenarioIdx = Number(val);
            state.customRatios = null; // ãƒªã‚»ãƒƒãƒˆã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ã†
            render(); // ã‚¤ãƒ³ãƒ—ãƒƒãƒˆæ¬„ã‚’æ›´æ–°ã™ã‚‹ãŸã‚å†æç”»
            updateHostQR();
        }

        function getScenarioRatios(idx) {
            // ãƒ©ãƒ³ãƒ€ãƒ (ID:7)ã®å ´åˆã¯ä¾¿å®œä¸Šå‡ç­‰å‰²ãªã©ã‚’è¿”ã—ã¦ãŠãï¼ˆå®Ÿéš›ã¯ãƒ¬ãƒ¼ã‚¹ä¸­è¨ˆç®—ï¼‰
            const s = PAYOUT_SCENARIOS[idx];
            if (!s.ratios) return [33, 33, 34];
            return s.ratios.map(r => Math.round(r * 100));
        }

        function updateCustomRatio(idx, val) {
            if (!state.customRatios) {
                state.customRatios = getScenarioRatios(state.payoutScenarioIdx);
            }
            state.customRatios[idx] = Number(val);

            const sum = state.customRatios.reduce((a, b) => a + b, 0);
            const errEl = document.getElementById('ratio-error');
            const btnEl = document.getElementById('start-btn-host');

            if (sum !== 100) {
                if (errEl) errEl.style.display = 'block';
                if (errEl) errEl.innerText = `åˆè¨ˆ: ${sum}% (ã‚ã¨${100 - sum}%)`;
                if (btnEl) { btnEl.style.opacity = '0.5'; btnEl.style.pointerEvents = 'none'; }
            } else {
                if (errEl) errEl.style.display = 'none';
                if (btnEl) { btnEl.style.opacity = '1'; btnEl.style.pointerEvents = 'auto'; }

                // ãƒ‘ã‚¿ãƒ¼ãƒ³è‡ªå‹•åˆ¤å®šï¼šå…¥åŠ›å€¤ã«æœ€ã‚‚è¿‘ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ
                let closestIdx = -1;
                let minDiff = Infinity;

                PAYOUT_SCENARIOS.forEach((s, i) => {
                    if (s.id === 7 || !s.ratios) return; // ãƒ©ãƒ³ãƒ€ãƒ ã¯é™¤å¤–
                    // ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ã®2ä¹—ã§æ¯”è¼ƒ
                    const diff = Math.pow((s.ratios[0] * 100) - state.customRatios[0], 2) +
                        Math.pow((s.ratios[1] * 100) - state.customRatios[1], 2) +
                        Math.pow((s.ratios[2] * 100) - state.customRatios[2], 2);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIdx = i;
                    }
                });

                if (closestIdx !== -1 && closestIdx !== state.payoutScenarioIdx) {
                    state.payoutScenarioIdx = closestIdx;
                    const sel = document.getElementById('payout-select');
                    if (sel) sel.value = closestIdx;
                }
            }
            updateHostQR();
        }

        function resetAsNewHost() {
            // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
            window.location.href = window.location.pathname;
        }

        function handleCountChange(val) {
            state.playerCount = Number(val);
            initHorseNames(state.playerCount, state.isHost);
            render();
        }

        function updateHorseName(idx, val) { if (state.isHost) state.horseNames[idx] = val; }

        function updateHostQR() {
            const qrEl = document.getElementById('qrcode');
            if (!qrEl) return;
            qrEl.innerHTML = '';
            const baseUrl = window.location.href.split('?')[0];
            let data = `${state.seed}-${state.playerCount}-${state.payoutScenarioIdx}-${state.riggedWinnerId}`;

            // ã‚«ã‚¹ã‚¿ãƒ æ¯”ç‡ãŒã‚ã‚Œã°è¿½åŠ 
            if (state.customRatios) {
                data += `-${state.customRatios.join('-')}`;
            }

            new QRCode(qrEl, { text: `${baseUrl}?d=${data}`, width: 140, height: 140 });
        }

        function selectPrediction(idx) {
            state.myPrediction = idx;
            document.getElementById('ticket-num').innerText = (idx + 1).toString().padStart(2, '0');
            document.getElementById('ticket-name').innerText = state.horseNames[idx];
            document.getElementById('ticket-modal').style.display = 'flex';
        }

        function closeModalForce() { document.getElementById('ticket-modal').style.display = 'none'; render(); }

        function startPreRaceSequence() {
            closeModalForce();
            state.gameState = 'pre_race';
            state.countdown = 7;
            render();
            playSound('fanfare');
            const timer = setInterval(() => {
                state.countdown--;
                if (state.countdown <= 0) { clearInterval(timer); startRace(); } else { render(); }
            }, 1000);
        }

        function renderPreRace(app) {
            app.innerHTML = `
                <div class="fanfare-screen">
                    <div style="font-size:1.5rem; font-weight:bold; text-shadow: 2px 2px 4px #000; z-index:10;">å‡ºèµ°ã¾ã§...</div>
                    <div class="fanfare-timer">${state.countdown}</div>
                </div>
            `;
        }

        function startRace() {
            playSound('gateOpen');
            setTimeout(() => playSound('running'), 100);
            const rng = new SeededRandom(state.seed);
            state.finishOrder = []; // ãƒªã‚»ãƒƒãƒˆ
            state.horses = Array.from({ length: state.playerCount }, (_, i) => {
                let baseSpd = rng.next() * 0.22 + 0.18;
                // æ”¯é…äººãƒ¢ãƒ¼ãƒ‰ã‹ã¤å‹é¦¬æŒ‡å®šãŒã‚ã‚‹å ´åˆã€å¯¾è±¡ã®é¦¬ã‚’å¼·åŒ–
                // æ”¯é…äººãƒ¢ãƒ¼ãƒ‰ã‹ã¤å‹é¦¬æŒ‡å®šãŒã‚ã‚‹å ´åˆã€å¯¾è±¡ã®é¦¬ã‚’å¼·åŒ–
                // ãŸã ã—ã€æœ€åˆã‹ã‚‰é€Ÿã™ãã‚‹ã¨ãƒãƒ¬ã‚‹ã®ã§ã€é€šå¸¸ã¨åŒã˜ã‹ã‚„ã‚„æŠ‘ãˆã‚ã«ã™ã‚‹ï¼ˆå¾ŒåŠã§ã¾ãã‚‹ï¼‰
                if (state.riggedWinnerId !== -1 && state.riggedWinnerId === i) {
                    // ä»¥å‰ã‚ˆã‚Šå°‘ã—ãƒ™ãƒ¼ã‚¹ã‚’ä¸Šã’ã¦å®‰å®šã•ã›ã‚‹ (min 0.25)
                    baseSpd = rng.next() * 0.12 + 0.25;
                }
                return {
                    id: i,
                    name: state.horseNames[i],
                    position: 0,
                    baseSpeed: baseSpd,
                    finished: false,
                    currentSpeed: 0,
                    speedModifier: 1.0,
                    statusEffect: '', // '', 'ğŸ”¥', 'ğŸ’¦'
                    gimmickTimer: 0
                };
            });
            state.gameState = 'racing';
            render();
            requestAnimationFrame(raceLoop);
        }

        function raceLoop() {
            if (state.gameState !== 'racing') return;

            // ç¾åœ¨ã®å…ˆé ­ã¨æœ€å¾Œå°¾ã‚’å–å¾—ï¼ˆã¾ã ã‚´ãƒ¼ãƒ«ã—ã¦ã„ãªã„é¦¬ã®ä¸­ã§ï¼‰
            const activeHorses = state.horses.filter(h => !h.finished);
            if (activeHorses.length === 0) {
                // å…¨é¦¬ã‚´ãƒ¼ãƒ«
                endRace();
                return;
            }

            // ä½ç½®ã§ã‚½ãƒ¼ãƒˆã—ã¦é †ä½ã‚’åˆ¤å®š
            activeHorses.sort((a, b) => b.position - a.position);
            const leader = activeHorses[0];
            const lastPlace = activeHorses[activeHorses.length - 1];

            state.horses.forEach(h => {
                if (h.finished) return;

                // --- ã‚®ãƒŸãƒƒã‚¯åˆ¤å®š ---
                // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚„æŒç¶šæ™‚é–“ã®ç®¡ç†
                if (h.gimmickTimer > 0) {
                    h.gimmickTimer--;
                    if (h.gimmickTimer <= 0) {
                        // åŠ¹æœçµ‚äº†
                        h.speedModifier = 1.0;
                        h.statusEffect = '';
                        updateHorseVisual(h);
                    }
                } else {
                    // æ–°ã—ã„ã‚®ãƒŸãƒƒã‚¯ã®ç™ºç”Ÿåˆ¤å®š (ãƒ©ãƒ³ãƒ€ãƒ æ€§ã®èª¿æ•´)
                    const rand = Math.random();

                    // 1. æœ€å¾Œå°¾ã®é€†è»¢ãƒ–ãƒ¼ã‚¹ãƒˆ (ğŸ”¥)
                    // æ¡ä»¶: æœ€å¾Œå°¾ã§ã‚ã‚‹ã€ãƒ¬ãƒ¼ã‚¹ä¸­ç›¤(20-80%)ã€ç¢ºç‡ä½ã‚

                    if (h === lastPlace && h.position > 20 && h.position < 80 && activeHorses.length > 1) {
                        if (rand < 0.02) { // 2%ã®ç¢ºç‡ã§ç™ºå‹•
                            h.speedModifier = 3.5; // è¶…åŠ é€Ÿ
                            h.gimmickTimer = 180; // ç´„3ç§’é–“ (60fpsæ›ç®—)
                            h.statusEffect = 'ğŸ”¥';
                            updateHorseVisual(h);
                        }
                    }

                    // 2. å…ˆé ­ã®å¤±é€Ÿ (ğŸ’¦)
                    // æ¡ä»¶: å…ˆé ­ã§ã‚ã‚‹ã€ãƒ¬ãƒ¼ã‚¹çµ‚ç›¤(60-95%)ã€ç¢ºç‡ä½ã‚
                    else if (h === leader && h.position > 60 && h.position < 95 && activeHorses.length > 1) {
                        // æ”¯é…äººãƒ¢ãƒ¼ãƒ‰ã®å‹ã¡é¦¬ã¯å¤±é€Ÿã—ãªã„
                        if (state.riggedWinnerId !== -1 && h.id === state.riggedWinnerId) {
                            // ä½•ã‚‚ã—ãªã„
                        } else {
                            if (rand < 0.015) { // 1.5%ã®ç¢ºç‡ã§ç™ºå‹•
                                h.speedModifier = 0.2; // æ¿€æ¸›é€Ÿ
                                h.gimmickTimer = 120; // ç´„2ç§’é–“
                                h.statusEffect = 'ğŸ’¦';
                                updateHorseVisual(h);
                            }
                        }
                    }
                }

                // --- ç§»å‹•å‡¦ç† ---
                // ãƒ™ãƒ¼ã‚¹é€Ÿåº¦ã«ãƒ©ãƒ³ãƒ€ãƒ æ€§ã¨è£œæ­£ã‚’åŠ ãˆã‚‹
                const randomFactor = (Math.random() * 0.12);
                let speed = (h.baseSpeed * 0.7 + randomFactor) * h.speedModifier;

                // --- æ”¯é…äººãƒ¢ãƒ¼ãƒ‰ã®å®‰å…¨è£…ç½® (Director AI) ---
                if (state.riggedWinnerId !== -1) {
                    const riggedHorse = state.horses[state.riggedWinnerId];
                    if (riggedHorse && !riggedHorse.finished) {

                        // A. ä¸­ç›¤(40m~)ã§ã€Œã¾ãã‚Šã€æ¼”å‡º: å‹è² ã‚’ä»•æ›ã‘ã‚‹
                        // ã¾ã ãƒ–ãƒ¼ã‚¹ãƒˆã—ã¦ãªãã¦ã€ã‚´ãƒ¼ãƒ«å‰ã§ã‚‚ãªã„å ´åˆ
                        if (h.id === state.riggedWinnerId && h.position > 40 && h.position < 70 && h.statusEffect !== 'ğŸ”¥') {
                            // ç¢ºç‡ã§ã€ã‚ã‚‹ã„ã¯é †ä½ãŒä½ã„å ´åˆã«ç™ºå‹•
                            if (Math.random() < 0.05) {
                                speed *= 2.5; // ãƒ–ãƒ¼ã‚¹ãƒˆ
                                h.gimmickTimer = 200; // é•·ã‚ã«
                                h.statusEffect = 'ğŸ”¥';
                                updateHorseVisual(h);
                            }
                        }

                        // B. çµ‚ç›¤(80m~)ã®æœ€çµ‚å®‰å…¨è£…ç½®
                        // è² ã‘ã¦ã„ã‚‹å ´åˆã€å¼·åˆ¶ãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆã‚ˆã‚Šå¼·åŠ›ã«ï¼‰
                        if (riggedHorse.position > 80 && h.id === state.riggedWinnerId && activeHorses[0] !== riggedHorse) {
                            speed *= 3.0; // é¬¼åŠ é€Ÿ
                            if (h.statusEffect !== 'ğŸ”¥') { h.statusEffect = 'ğŸ”¥'; updateHorseVisual(h); }
                        }

                        // C. çµ‚ç›¤(88m~)ã§å‹ã¡é¦¬ã‚ˆã‚Šå‰ã«ã„ã‚‹ãƒ©ã‚¤ãƒãƒ«ã¯å¼·åˆ¶å¤±é€Ÿ
                        if (h.id !== state.riggedWinnerId && h.position > 88 && h.position > riggedHorse.position) {
                            speed *= 0.1; // å¼·åˆ¶ãƒ–ãƒ¬ãƒ¼ã‚­
                            if (h.statusEffect !== 'ğŸ’¦') { h.statusEffect = 'ğŸ’¦'; updateHorseVisual(h); }
                        }
                    }
                }

                h.position += speed;

                // --- æ”¯é…äººãƒ¢ãƒ¼ãƒ‰ã®æœ€çµ‚é˜²è¡›ãƒ©ã‚¤ãƒ³ (God Mode) ---
                // å‹ã¡é¦¬ãŒã¾ã ã‚´ãƒ¼ãƒ«ã—ã¦ã„ãªã„å ´åˆã€ä»–ã®é¦¬ã¯çµ¶å¯¾ã«99%ã‚’è¶…ãˆã•ã›ãªã„
                if (state.riggedWinnerId !== -1 && h.id !== state.riggedWinnerId) {
                    const riggedHorse = state.horses[state.riggedWinnerId];
                    if (riggedHorse && !riggedHorse.finished) {
                        if (h.position > 99) {
                            h.position = 99; // å¯¸æ­¢ã‚
                        }
                    }
                }

                if (h.position >= 100) {
                    h.position = 100;
                    h.finished = true;
                    // ã‚´ãƒ¼ãƒ«ã—ãŸã‚‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’æ¶ˆã™
                    h.statusEffect = '';
                    updateHorseVisual(h);
                    // ã‚´ãƒ¼ãƒ«é †ã«ç™»éŒ²
                    state.finishOrder.push(h);
                }

                // --- ç”»é¢æ›´æ–° ---
                const el = document.getElementById(`h-${h.id}`);
                if (el) {
                    el.style.left = `calc(30px + ${h.position * 0.85}%)`;
                    // ã‚´ãƒ¼ãƒ«ãƒ©ã‚¤ãƒ³é€šéã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ãŒã‚ã‚Œã°ã“ã“ã«
                }
            });

            if (state.finishOrder.length === state.horses.length) {
                endRace();
            } else {
                requestAnimationFrame(raceLoop);
            }
        }

        function updateHorseVisual(h) {
            const backEl = document.getElementById(`h-status-back-${h.id}`);
            const frontEl = document.getElementById(`h-status-front-${h.id}`);

            if (backEl) backEl.innerText = '';
            if (frontEl) frontEl.innerText = '';

            if (h.statusEffect === 'ğŸ”¥') {
                if (backEl) {
                    backEl.innerText = 'ğŸ”¥';
                    backEl.style.transform = 'scale(1.5)';
                }
            } else if (h.statusEffect === 'ğŸ’¦') {
                if (frontEl) {
                    frontEl.innerText = 'ğŸ’¦';
                    frontEl.style.transform = 'scale(1.2)';
                }
            }
        }

        function endRace() {
            stopSound('running');
            playSound('applause');
            // ç€é †ã‚’ç¢ºå®š (finishOrderã‚’ä½¿ç”¨)
            state.allFinishedRanks = [...state.finishOrder];
            // å¿µã®ãŸã‚ã€finishOrderã«å…¥ã£ã¦ã„ãªã„é¦¬ãŒã„ã‚Œã°ï¼ˆãƒã‚°å¯¾ç­–ï¼‰ã€è·é›¢é †ãªã©ã§è¿½åŠ 
            const missing = state.horses.filter(h => !state.finishOrder.includes(h));
            if (missing.length > 0) {
                missing.sort((a, b) => b.position - a.position);
                state.allFinishedRanks = state.allFinishedRanks.concat(missing);
            }

            state.winners = state.allFinishedRanks.slice(0, 3);
            state.gameState = 'reveal_ranks';
            setTimeout(render, 500);
        }

        function renderRacing(app) {
            const hasPrediction = state.myPrediction !== null;
            const myNum = hasPrediction ? (state.myPrediction + 1).toString().padStart(2, '0') : '--';
            const myName = hasPrediction ? state.horseNames[state.myPrediction] : '';

            const badgeHtml = hasPrediction ? `<div class="my-ticket-badge">ã‚ãªãŸã®é¦¬åˆ¸ï¼š${myNum} ${myName}</div>` : `<div class="my-ticket-badge" style="background:#ddd; color:#666;">æ”¯é…äººè¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰</div>`;

            app.innerHTML = `
                <div class="race-screen">
                    <div class="race-header">
                        <div style="font-size:0.8rem; font-weight:bold;">å®Ÿæ³ï¼šç¬¬26å› ä¸™åˆæ¯ãƒ€ãƒ¼ãƒ“ãƒ¼</div>
                        ${badgeHtml}
                    </div>
                    <div class="track-area">
                        <div class="goal-line"></div>
                        ${state.horses.map(h => {
                const isMyHorse = hasPrediction && h.id === state.myPrediction;
                const laneStyle = isMyHorse ? 'background: #bcaaa4; border-bottom: 2px solid #3e2723;' : '';
                return `
                            <div class="lane" style="${laneStyle}">
                                <div class="lane-sidebar" style="${isMyHorse ? 'background:var(--accent);' : ''}">${h.id + 1}</div>
                                <div class="lane-bg-name" style="${isMyHorse ? 'color:#ffebee;' : ''}">${h.name}</div>
                                <div id="h-${h.id}" class="horse-sprite" style="left: 30px;">
                                    <span id="h-status-back-${h.id}" style="font-size:1.5rem; margin-right:5px; transition:transform 0.2s;"></span>
                                    <span class="horse-emoji">ğŸ</span>
                                    <span id="h-status-front-${h.id}" style="font-size:1.5rem; margin-left:5px; transition:transform 0.2s;"></span>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }

        function renderRankReveal(container) {
            container.innerHTML = `
                <h2 style="font-size:1.2rem; margin:20px 0;">ç€é †ç¢ºå®š</h2>
                <div style="margin-bottom:30px;">
                    ${state.winners.map((w, i) => `
                        <div class="reveal-item" style="animation-delay:${i * 0.6}s; background:white; border:2px solid var(--primary); padding:15px; margin:10px auto; max-width:400px; display:flex; align-items:center; gap:15px;">
                            <span style="font-size:2rem;">${['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i]}</span>
                            <div style="text-align:left;">
                                <div style="font-size:0.8rem; font-weight:bold;">${i + 1}ç€ï¼š${w.id + 1}ç•ª</div>
                                <div style="font-size:1.4rem; font-weight:900;">${w.name}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div onclick="startLottery()" class="btn btn-primary" style="animation: stamp 0.5s 2s forwards; opacity:0;">é…å½“æŠ½é¸ã¸é€²ã‚€</div>
            `;
        }

        function startLottery() {
            state.gameState = 'lottery'; state.isLotterySpinning = true; render();
            playSound('drumroll');

            const targetIdx = state.payoutScenarioIdx;
            const max = 30;
            // é€†ç®—ã—ã¦é–‹å§‹ä½ç½®ã‚’æ±ºã‚ã‚‹ (start + max) % len == target
            let currentIdx = (targetIdx - (max % PAYOUT_SCENARIOS.length) + PAYOUT_SCENARIOS.length) % PAYOUT_SCENARIOS.length;
            state.payoutScenarioIdx = currentIdx;

            let count = 0;
            const interval = setInterval(() => {
                count++;
                state.payoutScenarioIdx = (state.payoutScenarioIdx + 1) % PAYOUT_SCENARIOS.length;
                render();
                if (count >= max) {
                    clearInterval(interval); stopSound('drumroll'); playSound('finish');
                    state.isLotterySpinning = false;
                    state.payoutScenarioIdx = targetIdx; // å¿µã®ãŸã‚è£œæ­£
                    state.payoutMode = calculateDistribution(PAYOUT_SCENARIOS[state.payoutScenarioIdx], state.playerCount, state.customRatios);
                    render();
                }
            }, 100);
        }

        function calculateDistribution(scenario, total, overrideRatios = null) {
            let dist = [0, 0, 0];

            if (overrideRatios) {
                // ã‚«ã‚¹ã‚¿ãƒ æ¯”ç‡(%)ã‹ã‚‰è¨ˆç®—
                dist = overrideRatios.map(r => Math.floor(total * (r / 100)));
                let diff = total - dist.reduce((a, b) => a + b, 0);
                for (let i = 0; i < diff; i++) dist[i % 3]++;
            }
            else if (scenario.id === 7) {
                let r1 = Math.floor(Math.random() * total);
                let r2 = Math.floor(Math.random() * (total - r1));
                dist = [r1, r2, total - r1 - r2];
            } else {
                dist = scenario.ratios.map(r => Math.floor(total * r));
                let diff = total - dist.reduce((a, b) => a + b, 0);
                for (let i = 0; i < diff; i++) dist[i % 3]++;
            }
            return { ...scenario, dist };
        }

        function renderLottery(container) {
            const current = PAYOUT_SCENARIOS[state.payoutScenarioIdx];
            container.innerHTML = `
                <h2 style="font-size:1.2rem; margin:20px 0;">é…å½“è¦å®š æŠ½é¸ä¸­</h2>
                <div class="lottery-box ${!state.isLotterySpinning ? 'active' : ''}">${current.name}</div>
                <p>${!state.isLotterySpinning ? current.desc : 'è¦å®šã‚’å¯©è­°ä¸­...'}</p>
                ${!state.isLotterySpinning ? `<div onclick="state.gameState='finished'; render();" class="btn btn-primary">æœ€çµ‚æ²ç¤ºæ¿ã¸</div>` : ''}
            `;
        }

        function renderFinished(container) {
            const hasPrediction = state.myPrediction !== null;
            const myRankIdx = hasPrediction ? state.allFinishedRanks.findIndex(h => h.id === state.myPrediction) : -1;
            const myRankText = (myRankIdx !== -1) ? `${myRankIdx + 1}ç€` : "åœå¤–";
            const isWin = myRankIdx === 0;
            const isPodium = myRankIdx >= 0 && myRankIdx < 3;

            const predictionResultHtml = hasPrediction ? `
                <h2 style="font-size:1.8rem; margin:20px 0;">${isWin ? 'ğŸŠ äºˆæƒ³çš„ä¸­ï¼' : 'çµ‚å¹•'}</h2>
                <div style="background: white; border: 2px dashed ${isPodium ? 'var(--success)' : 'var(--accent)'}; padding: 12px; margin-bottom: 20px; display: inline-block; min-width: 200px;">
                    <div style="font-size: 0.75rem; color: #666;">ã‚ãªãŸã®äºˆæƒ³ã¨çµæœ</div>
                    <div style="font-size: 1.3rem; font-weight: 900; margin: 4px 0;">${state.myPrediction + 1}ç•ª ${state.horseNames[state.myPrediction]}</div>
                    <div style="font-size: 1.1rem; font-weight: 900; color: ${isPodium ? 'var(--success)' : 'var(--accent)'};">æœ€çµ‚ï¼š${myRankText}</div>
                </div>
            ` : `
                <h2 style="font-size:1.8rem; margin:20px 0;">ãƒ¬ãƒ¼ã‚¹çµ‚äº†</h2>
                <div style="margin-bottom:20px; font-weight:bold; color:#666;">ï¼ˆæ”¯é…äººãƒ¢ãƒ¼ãƒ‰ã§è¦³æˆ¦ä¸­ï¼‰</div>
            `;

            container.innerHTML = `
                <div style="margin-bottom:20px;">
                    ${predictionResultHtml}

                    <div style="display:flex; justify-content:center; align-items:stretch; gap:5px; width:100%; box-sizing:border-box;">
                        ${state.winners.map((w, i) => `
                            <div style="border:2px solid var(--primary); padding:8px 4px; background:${i == 0 ? '#fffde7' : 'white'}; width: 33.3%; box-sizing:border-box; display:flex; flex-direction:column; align-items:center; justify-content:space-between; min-width:0;">
                                <div style="font-size:0.7rem; font-weight:bold;">${i + 1}ç€</div>
                                <div style="font-size:1.8rem; font-weight:900; line-height: 1; margin: 4px 0;">${w.id + 1}ç•ª</div>
                                <div style="font-size:0.65rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%; text-align:center;">${w.name}</div>
                                <div style="margin-top:6px; font-size:1.5rem; font-weight:900; color:var(--accent); line-height: 1.1;">${state.payoutMode.dist[i]}/${state.playerCount}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="btn-group">
                    ${state.isHost ? `
                        <div onclick="location.reload()" class="btn btn-primary">å† ä¸»ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ã¨ã—ã¦æ¬¡ã‚’é–‹å‚¬</div>
                    ` : `
                        <div class="guest-notice">
                            å†åº¦ãƒ¬ãƒ¼ã‚¹ã‚’æ¥½ã—ã‚€ã«ã¯ã€<br>ãƒ›ã‚¹ãƒˆã‹ã‚‰æ–°ã—ã„QRã‚³ãƒ¼ãƒ‰ã‚’<br>å—ã‘å–ã£ã¦ãã ã•ã„ã€‚
                        </div>
                        <div onclick="resetAsNewHost()" class="btn btn-primary">è‡ªåˆ†ãŒå† ä¸»ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ã«ãªã£ã¦é–‹å‚¬</div>
                    `}
                    <div onclick="window.location.href='https://fumifum1.github.io/main/game.html'" class="btn btn-outline" style="font-size:0.8rem;">ä»–ã®ã‚²ãƒ¼ãƒ ã§éŠã¶</div>
                </div>
            `;
        }

        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('d')) {
                const parts = params.get('d').split('-').map(Number);
                const s = parts[0];
                const c = parts[1];
                const p = parts[2];
                const w = parts.length > 3 ? parts[3] : -1; // 4ã¤ç›®ãŒã‚ã‚Œã°å‹é¦¬ID

                // 5,6,7ã¤ç›®ãŒã‚ã‚Œã°ã‚«ã‚¹ã‚¿ãƒ æ¯”ç‡
                let ratios = null;
                if (parts.length > 6) {
                    ratios = [parts[4], parts[5], parts[6]];
                }

                state.seed = s; state.playerCount = c; state.payoutScenarioIdx = p;
                state.riggedWinnerId = w;
                state.customRatios = ratios;
                state.isHost = false; state.gameState = 'host_setup';
                initHorseNames(state.playerCount, false);
            } else {
                initHorseNames(state.playerCount, false);
            }
            render();
        });
    </script>
</body>

</html>